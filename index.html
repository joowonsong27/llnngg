<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LNG OF LEGEND</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        /* ê³µí†µ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .screen.active {
            display: flex;
        }

        .box {
            background: #16213e;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            text-align: center;
        }

        h1 {
            color: #00fff5;
            margin-bottom: 30px;
            font-size: 32px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        h2 {
            color: #00fff5;
            margin-bottom: 20px;
            font-size: 24px;
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #00fff5;
            background: #0f3460;
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        button {
            padding: 15px 30px;
            margin: 10px;
            background: #00fff5;
            color: #16213e;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            background: #00d4cc;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.7);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* ë‹‰ë„¤ì„ í™”ë©´ */
        #nicknameScreen .box {
            min-width: 400px;
        }

        /* ì§ì—… ì„ íƒ í™”ë©´ */
        #classScreen .box {
            min-width: 600px;
            max-width: 700px;
            padding: 30px;
        }

        .class-swiper {
            position: relative;
            width: 100%;
            height: 480px;
            overflow: hidden;
            margin: 20px 0;
        }

        .class-slider {
            display: flex;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            height: 100%;
        }

        .class-slide {
            min-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 40px;
        }

        .class-card {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border: 3px solid #00fff5;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 255, 255, 0.3);
        }

        .class-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #00fff5;
        }

        .class-card .class-icon {
            font-size: 64px;
            margin: 15px 0;
        }

        .class-card .description {
            color: #aaa;
            margin: 15px 0;
            font-size: 16px;
        }

        .class-card .stats {
            text-align: left;
            font-size: 15px;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }

        .class-card .stats div {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(0, 255, 245, 0.1);
            border-radius: 6px;
            border-left: 3px solid #00fff5;
        }

        .swiper-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(0, 255, 245, 0.2);
            border: 2px solid #00fff5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            font-size: 24px;
            color: #00fff5;
            user-select: none;
        }

        .swiper-nav:hover {
            background: rgba(0, 255, 245, 0.4);
            transform: translateY(-50%) scale(1.1);
        }

        .swiper-nav.prev {
            left: 10px;
        }

        .swiper-nav.next {
            right: 10px;
        }

        .swiper-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .swiper-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .swiper-dot.active {
            background: #00fff5;
            width: 30px;
            border-radius: 6px;
        }

        /* ë°© ì„ íƒ í™”ë©´ */
        #roomScreen .box {
            min-width: 480px;
            max-width: 560px;
        }

        .room-list {
            max-height: 320px;
            overflow-y: auto;
            margin: 16px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .room-item {
            background: #0f3460;
            border: 2px solid rgba(0,255,245,0.3);
            border-radius: 8px;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .room-item:hover {
            border-color: #00fff5;
            background: rgba(0,255,245,0.1);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 255, 245, 0.2);
        }

        .room-item .room-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .room-item .room-host {
            font-weight: bold;
            font-size: 16px;
            color: #00fff5;
        }

        .room-item .room-count {
            font-size: 13px;
            color: #aaa;
        }
        .room-empty {
            color: #555;
            font-size: 14px;
            text-align: center;
            padding: 30px 0;
        }

        .room-create-btn {
            width: 100%;
            margin: 0;
            padding: 14px;
            font-size: 16px;
            background: #16213e;
            color: #00fff5;
            border: 2px solid #00fff5;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 1px;
        }

        .room-create-btn:hover {
            background: #00fff5;
            color: #16213e;
        }

        /* ëŒ€ê¸°ì‹¤ í™”ë©´ */
        #lobbyScreen .box {
            min-width: 700px;
            max-width: 900px;
        }

        .lobby-info {
            background: #0f3460;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .lobby-player {
            background: #0f3460;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid transparent;
        }

        .lobby-player.ready {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .lobby-player.host {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .lobby-player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .lobby-player-class {
            background: rgba(0, 255, 245, 0.2);
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 14px;
        }

        .lobby-player-status {
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .lobby-player-status.ready {
            background: #00ff00;
            color: #000;
        }

        .lobby-player-status.waiting {
            background: #ff9800;
            color: #000;
        }

        .lobby-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* ê²Œì„ ëŒ€ê¸° í™”ë©´ */
        #waitingScreen .box {
            min-width: 500px;
        }

        .waiting-message {
            font-size: 20px;
            margin: 20px 0;
            color: #00fff5;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #0f3460;
            border-top-color: #00fff5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ê²Œì„ í™”ë©´ */
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameCanvas {
            background: #0f3460;
            border: 3px solid #16213e;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }

        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(22, 33, 62, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00fff5;
            min-width: 250px;
        }

        #info h3 {
            color: #00fff5;
            margin-bottom: 15px;
        }

        #info p {
            margin: 8px 0;
            font-size: 14px;
        }

        #playerList {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(22, 33, 62, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00fff5;
            min-width: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        #playerList h3 {
            color: #00fff5;
            margin-bottom: 15px;
        }

        .player-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(0, 255, 245, 0.1);
            border-radius: 5px;
            display: flex;
            align-items: center;
        }

        .player-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #fff;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(22, 33, 62, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #00fff5;
        }

        #controls p {
            margin: 5px 0;
            font-size: 14px;
        }

        .error {
            color: #ff4757;
            margin-top: 10px;
            font-size: 14px;
        }

        .loading {
            color: #00fff5;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- ë‹‰ë„¤ì„ ì…ë ¥ í™”ë©´ -->
    <div id="nicknameScreen" class="screen active">
        <div class="box">
            <h1>âš”ï¸ LNG OF LEGEND</h1>
            <p style="color: #aaa; margin-bottom: 20px;">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (ìµœëŒ€ 12ì)" maxlength="12">
            <button id="nicknameNextBtn">ë‹¤ìŒ</button>
            <p class="error" id="nicknameError"></p>
        </div>
    </div>

    <!-- ì§ì—… ì„ íƒ í™”ë©´ -->
    <div id="classScreen" class="screen">
        <div class="box">
            <h1>âš”ï¸ ì§ì—… ì„ íƒ</h1>
            <p style="color: #aaa; margin-bottom: 10px;">ì¢Œìš°ë¡œ ë„˜ê²¨ ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</p>
            <div class="class-swiper">
                <div class="class-slider" id="classSlider">
                    <!-- ì§ì—… ìŠ¬ë¼ì´ë“œê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
                <div class="swiper-nav prev" id="swiperPrev">â€¹</div>
                <div class="swiper-nav next" id="swiperNext">â€º</div>
            </div>
            <div class="swiper-dots" id="swiperDots"></div>
            <button id="classSelectBtn" disabled>ì„ íƒ ì™„ë£Œ</button>
            <p class="error" id="classError"></p>
        </div>
    </div>

    <!-- ë°© ì„ íƒ í™”ë©´ -->
    <div id="roomScreen" class="screen">
        <div class="box">
            <h1>ğŸ  ë°© ì„ íƒ</h1>
            <p style="color:#aaa; margin-bottom:4px; font-size:14px;">ë°©ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“œì„¸ìš”</p>
            <div class="room-list" id="roomList">
                <div class="room-empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <button class="room-create-btn" id="createRoomBtn">+ ìƒˆ ë°© ë§Œë“¤ê¸°</button>
            <p class="error" id="roomError" style="margin-top:10px;"></p>
        </div>
    </div>

    <!-- ëŒ€ê¸°ì‹¤ í™”ë©´ -->
    <div id="lobbyScreen" class="screen">
        <div class="box">
            <h1 id="lobbyTitle">ğŸ  ëŒ€ê¸°ì‹¤</h1>
            <div class="lobby-info">
                <p>ì ‘ì† ì¸ì›: <span id="lobbyPlayerCount">0</span>ëª…</p>
                <p id="hostIndicator" style="color: #ffd700; display: none;">ğŸ‘‘ ë‹¹ì‹ ì€ ë°©ì¥ì…ë‹ˆë‹¤</p>
            </div>
            <h2>í”Œë ˆì´ì–´ ëª©ë¡</h2>
            <div class="player-list" id="lobbyPlayerList">
                <!-- í”Œë ˆì´ì–´ ëª©ë¡ì´ ì—¬ê¸° ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            <div class="lobby-buttons">
                <button id="readyBtn">ì¤€ë¹„ ì™„ë£Œ</button>
                <button id="startBtn" style="display: none;" disabled>ê²Œì„ ì‹œì‘</button>
                <button id="practiceBtn" style="display: none; background: #9b59b6;">ì—°ìŠµ ëª¨ë“œ</button>
            </div>
            <p class="error" id="lobbyError"></p>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameContainer">
        <canvas id="gameCanvas" width="1200" height="800"></canvas>
    </div>

    <div id="info">
        <h3>ğŸ“Š ê²Œì„ ì •ë³´</h3>
        <p>ë‹‰ë„¤ì„: <span id="myNickname">-</span></p>
        <p>ì§ì—…: <span id="myClass">-</span></p>
        <p>ì²´ë ¥: <span id="myHealth">-</span></p>
        <p>ì ‘ì† ì¸ì›: <span id="playerCount">0</span>ëª…</p>
    </div>

    <div id="playerList">
        <h3>ğŸ‘¥ í”Œë ˆì´ì–´</h3>
        <div id="playerListContent"></div>
    </div>

    <div id="controls">
        <h3 style="color: #00fff5; margin-bottom: 10px;">&#127918; ì¡°ì‘ë²•</h3>
        <p>&#9000; WASD: ì´ë™</p>
        <p>&#128432; ì¢Œí´ë¦­: ê¸°ë³¸ ê³µê²©</p>
        <p>&#128432; ìš°í´ë¦­: <span id="skillActionLabel">ìŠ¤í‚¬</span></p>
        <p>Shift: ëŒ€ì‰¬</p>
        <p style="color: #ff4444;">R 3ì´ˆ: ê°•ì œ ì¢…ë£Œ</p>
        <hr style="border-color: #00fff5; margin: 10px 0;">
        <h3 style="color: #00fff5; margin-bottom: 8px;">ì¿¨íƒ€ì„</h3>
        <div id="cooldownHUD">
            <div style="margin: 6px 0;">
                <div style="display:flex; justify-content:space-between; font-size:13px;">
                    <span>ëŒ€ì‰¬</span><span id="dashCoolText" style="color:#00fff5">ì¤€ë¹„</span>
                </div>
                <div style="background:#0f3460; border-radius:4px; height:8px; margin-top:3px;">
                    <div id="dashCoolBar" style="height:8px; border-radius:4px; background:#00fff5; width:100%;"></div>
                </div>
            </div>
            <div style="margin: 6px 0;">
                <div style="display:flex; justify-content:space-between; font-size:13px;">
                    <span id="skillNameLabel">ìŠ¤í‚¬</span><span id="skillCoolText" style="color:#ff4444">ì¤€ë¹„</span>
                </div>
                <div style="background:#0f3460; border-radius:4px; height:8px; margin-top:3px;">
                    <div id="skillCoolBar" style="height:8px; border-radius:4px; background:#ff4444; width:100%;"></div>
                </div>
            </div>
        </div>
        <p id="spectateHint" style="display:none; color:#aaa; font-size:12px; margin-top:8px;">í´ë¦­ìœ¼ë¡œ ê´€ì „ ì „í™˜</p>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ========== Firebase ì„¤ì • ==========
        const firebaseConfig = {
            apiKey: "AIzaSyBl2xG5QDEISFwOi-sNqn5eW70BpNuRZdU",
            authDomain: "llnngg.firebaseapp.com",
            databaseURL: "https://llnngg-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "llnngg",
            storageBucket: "llnngg.firebasestorage.app",
            messagingSenderId: "849568964604",
            appId: "1:849568964604:web:d727d027262539887c9c79"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const roomsRef = database.ref('rooms');

        // í˜„ì¬ ë°© ID (ë°© ì„ íƒ/ìƒì„± í›„ ì„¤ì •ë¨)
        let currentRoomId = null;

        // ë°© ê¸°ë°˜ ë™ì  refs (joinRoom í›„ ì´ˆê¸°í™”)
        let playersRef, gameStateRef, bulletsRef, particlesRef, swingsRef, stabsRef, smokesRef, hitEffectsRef, smithHammersRef, samuraiSlashesRef, parryHitsRef;

        function initRoomRefs(roomId) {
            const base = database.ref('rooms/' + roomId);
            playersRef    = base.child('players');
            gameStateRef  = base.child('gameState');
            bulletsRef    = base.child('bullets');
            particlesRef  = base.child('particles');
            swingsRef     = base.child('swings');
            stabsRef      = base.child('stabs');
            smokesRef     = base.child('smokes');
            hitEffectsRef = base.child('hitEffects');
            smithHammersRef = base.child('smithHammers');
            samuraiSlashesRef = base.child('samuraiSlashes');
            parryHitsRef = base.child('parryHits');
        }

        // ========== ì§ì—… ë°ì´í„° ==========
        const CLASSES = {
            infantry: {
                id: 'infantry',
                name: 'ë³´ë³‘',
                icon: 'ğŸ›¡ï¸',
                description: 'ì´ìœ¼ë¡œ ì ì„ ì œì••í•˜ëŠ” ì›ê±°ë¦¬ ì‚¬ê²©ìˆ˜',
                stats: { moveSpeed: 5, attack: 20, attackSpeed: 1.125, health: 100 },
                color: '#4ECDC4',
                bulletSpeed: 22.5,
                skill: { name: 'ì—°ì‚¬', cooldown: 10, bullets: 10, bulletSpeed: 22.5, bulletInterval: 100 }
            },
            warrior: {
                id: 'warrior',
                name: 'ì›Œë¦¬ì–´',
                icon: 'âš”ï¸',
                description: 'ê°•ì¸í•œ ê·¼ì ‘ ì „ì‚¬',
                stats: { moveSpeed: 4.5, attack: 20, attackSpeed: 1.5, health: 130 },
                color: '#e74c3c',
                skill: { name: 'ì „íˆ¬ íƒœì„¸', cooldown: 15 }
            },
            assassin: {
                id: 'assassin',
                name: 'ì–´ìŒ”ì‹ ',
                icon: 'ğŸ—¡ï¸',
                description: 'ì€ì‹ ìœ¼ë¡œ ì ì„ ê¸°ìŠµí•˜ëŠ” ì•”ì‚´ì',
                stats: { moveSpeed: 5.5, attack: 30, attackSpeed: 2.5, health: 80 },
                color: '#9b59b6',
                skill: { name: 'ì€ì‹ ', cooldown: 8 }
            },
            blacksmith: {
                id: 'blacksmith',
                name: 'ëŒ€ì¥ì¥ì´',
                icon: 'ğŸ”¨',
                description: 'ê°•í™”ë¥¼ ê±°ë“­í• ìˆ˜ë¡ ë”ìš± ê°•í•´ì§€ëŠ” ì „ì¥ì˜ ëŒ€ì¥ì¥ì´',
                stats: { moveSpeed: 4, attack: 10, attackSpeed: 0.5, health: 80 },
                color: '#e67e22',
                skill: { name: 'ê°•í™”', cooldown: 4 }
            },
            samurai: {
                id: 'samurai',
                name: 'ì‚¬ë¬´ë¼ì´',
                icon: 'â›©ï¸',
                description: 'ë‚ ì¹´ë¡œìš´ ë² ê¸°ì™€ íŒ¨ë§ìœ¼ë¡œ ì ì„ ì œì••í•˜ëŠ” ê²€ê°',
                stats: { moveSpeed: 4.5, attack: 20, attackSpeed: 1, health: 100 },
                color: '#c0392b',
                skill: { name: 'íŒ¨ë§', cooldown: 8 }
            }
        };

        // ì›Œë¦¬ì–´ ì „ìš© ìƒíƒœ
        let warriorSkillActive = false;       // ìŠ¤í‚¬ í™œì„±í™” ì—¬ë¶€
        let warriorSkillEnd = 0;              // ìŠ¤í‚¬ ì¢…ë£Œ ì‹œê°„
        let warriorSpinReady = false;         // íšŒì „ ê³µê²© ì¤€ë¹„ ì—¬ë¶€
        let warriorSwingActive = false;       // ê²€ íœ˜ë‘ë¥´ê¸° ì• ë‹ˆë©”ì´ì…˜ ì¤‘
        let warriorSwingAngle = 0;            // í˜„ì¬ íœ˜ë‘ë¥´ê¸° ê°ë„
        let warriorSwingDir = 0;              // íœ˜ë‘ë¥´ê¸° ê¸°ì¤€ ê°ë„
        let warriorSwingFrames = 0;           // ë‚¨ì€ ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„
        const WARRIOR_SWING_TOTAL = 10;       // íœ˜ë‘ë¥´ê¸° ì´ í”„ë ˆì„
        const WARRIOR_SWING_RANGE = 102;      // ê²€ ë„ë‹¬ ë²”ìœ„ (px) â€” ê¸°ì¡´ 85ì˜ 120%
        const WARRIOR_SPIN_RANGE = 170;       // íšŒì „ ê³µê²© ë²”ìœ„ (px) â€” ê¸°ì¡´ 85ì˜ 200%
        const WARRIOR_SWING_ARC = Math.PI * 1.0; // 180ë„ í˜¸
        const WARRIOR_SPIN_ARC = Math.PI * 2;    // 360ë„ í˜¸
        const swingHitIds = new Set();        // ì´ë²ˆ íœ˜ë‘ë¥´ê¸°ì—ì„œ ì´ë¯¸ ë§ì€ ëŒ€ìƒ
        let _currentSwingArc = Math.PI * 1.0; // í˜„ì¬ íœ˜ë‘ë¥´ê¸° ê°ë„ ë²”ìœ„
        let _currentSwingRange = WARRIOR_SWING_RANGE; // í˜„ì¬ íœ˜ë‘ë¥´ê¸° ë²”ìœ„

        // ì–´ìŒ”ì‹  ì „ìš© ìƒíƒœ
        let assassinStealthActive = false;    // ì€ì‹  ì—¬ë¶€
        let assassinStealthEnd = 0;           // ì€ì‹  ì¢…ë£Œ ì‹œê°„
        const ASSASSIN_STAB_RANGE = 65;       // ì°Œë¥´ê¸° ì‚¬ê±°ë¦¬
        const ASSASSIN_STAB_TOTAL = 8;        // ì°Œë¥´ê¸° ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„
        let assassinStabActive = false;       // ì°Œë¥´ê¸° ì• ë‹ˆë©”ì´ì…˜ ì¤‘
        let assassinStabFrames = 0;           // ë‚¨ì€ í”„ë ˆì„
        let assassinStabDir = 0;              // ì°Œë¥´ê¸° ë°©í–¥
        let assassinStabHit = false;          // ì´ë²ˆ ì°Œë¥´ê¸°ì—ì„œ ì´ë¯¸ íˆíŠ¸
        const assassinSmokeParticles = [];    // ì—°ê¸° íŒŒí‹°í´ (ë¡œì»¬)

        // ëŒ€ì¥ì¥ì´ ì „ìš© ìƒíƒœ
        let smithForging = false;             // ê°•í™” ê²½ì§ ì¤‘ ì—¬ë¶€
        let smithForgeEnd = 0;                // ê²½ì§ ì¢…ë£Œ ì‹œê°„
        let smithEnhanceLevel = 0;            // ê°•í™” íšŸìˆ˜ (ê²Œì„ ë‚´ ë¦¬ì…‹)
        let smithHammerActive = false;        // ë§ì¹˜ ê³µê²© ì• ë‹ˆë©”ì´ì…˜ ì¤‘
        let smithHammerFrames = 0;            // ë§ì¹˜ ê³µê²© ë‚¨ì€ í”„ë ˆì„
        let smithHammerDir = 0;              // ë§ì¹˜ ë°©í–¥
        let smithHammerHit = false;           // ì´ë²ˆ ê³µê²©ì—ì„œ íˆíŠ¸
        const SMITH_HAMMER_TOTAL = 12;        // ë§ì¹˜ ê³µê²© ì´ í”„ë ˆì„
        const SMITH_HAMMER_HIT_FRAME = 4;     // ì´ í”„ë ˆì„ ì´í›„ë¶€í„° íˆíŠ¸ íŒì •
        const SMITH_HAMMER_RANGE = 55;        // ë§ì¹˜ ë„ë‹¬ ë²”ìœ„ (ì‚¬ê°í˜• í­ ì ˆë°˜)
        const SMITH_HAMMER_HEIGHT = 60;       // ì‚¬ê°í˜• ë†’ì´
        const smithHammerHitIds = new Set();  // ì´ë²ˆ ê³µê²©ì—ì„œ ë§ì€ ëŒ€ìƒ
        const playerHammers = {};             // ë‹¤ë¥¸ í”Œë ˆì´ì–´ ë§ì¹˜ ê³µê²© ìƒíƒœ

        // ì‚¬ë¬´ë¼ì´ ì „ìš© ìƒíƒœ
        const SAMURAI_SLASH_TOTAL = 10;       // ì°Œë¥´ê¸° ì• ë‹ˆë©”ì´ì…˜ ì´ í”„ë ˆì„
        const SAMURAI_MAX_CHARGE = 2500;      // ìµœëŒ€ ì°¨ì§• ì‹œê°„ (ms)
        // ì°¨ì§• ë‹¨ê³„ë³„ ìŠ¤íƒ¯ (0~6ë‹¨ê³„)
        const SAMURAI_CHARGE_LEVELS = [
            { minTime: 0,    maxTime: 417,  dmg: 5,  length: 80,  width: 30, dashFrames: 5,  dashSpeed: 10 },
            { minTime: 417,  maxTime: 833,  dmg: 10, length: 105, width: 36, dashFrames: 6,  dashSpeed: 11 },
            { minTime: 833,  maxTime: 1250, dmg: 15, length: 130, width: 40, dashFrames: 7,  dashSpeed: 12 },
            { minTime: 1250, maxTime: 1667, dmg: 20, length: 155, width: 44, dashFrames: 8,  dashSpeed: 13 },
            { minTime: 1667, maxTime: 2083, dmg: 25, length: 175, width: 48, dashFrames: 9,  dashSpeed: 14 },
            { minTime: 2083, maxTime: 2500, dmg: 30, length: 195, width: 52, dashFrames: 10, dashSpeed: 15 },
            { minTime: 2500, maxTime: 9999, dmg: 35, length: 220, width: 58, dashFrames: 12, dashSpeed: 17 },
        ];
        // ì°¨ì§• ìƒíƒœ
        let samuraiCharging = false;          // ë§ˆìš°ìŠ¤ ëˆ„ë¥´ê³  ìˆìŒ
        let samuraiChargeStart = 0;           // ì°¨ì§• ì‹œì‘ ì‹œê°
        let samuraiChargeDir = 0;             // ì°¨ì§• ë°©í–¥ (ëˆ„ë¥¼ ë•Œ ë§ˆìš°ìŠ¤ ë°©í–¥)
        let samuraiChargeTimerId = null;      // ìë™ë°œì‚¬ setTimeout ID (ì¤‘ë³µ ë°©ì§€)
        let samuraiCurrentLevel = null;       // ë°œì‚¬ ì‹œ í™•ì •ëœ ë ˆë²¨ ê°ì²´
        let samuraiSlashActive = false;       // ì°Œë¥´ê¸° ì¤‘
        let samuraiSlashFrames = 0;           // ë‚¨ì€ í”„ë ˆì„
        let samuraiSlashDir = 0;              // ì°Œë¥´ê¸° ë°©í–¥
        let samuraiSlashProgress = 0;         // ì°Œë¥´ê¸° ì§„í–‰ë„ (0~1)
        let samuraiSlashDashFrames = 0;       // ëŒì§„ ë‚¨ì€ í”„ë ˆì„
        let samuraiSlashDashVx = 0;
        let samuraiSlashDashVy = 0;
        const samuraiSlashHitIds = new Set(); // ì´ë²ˆ ì°Œë¥´ê¸°ì— ë§ì€ ëŒ€ìƒ

        let samuraiParryActive = false;       // íŒ¨ë§ ê²½ì§ ì¤‘
        let samuraiParryEnd = 0;              // íŒ¨ë§ ì¢…ë£Œ ì‹œê°„
        let samuraiParryHit = false;          // íŒ¨ë§ ì¤‘ ê³µê²© ë°›ì•˜ëŠ”ì§€
        let samuraiParryDir = 0;              // íŒ¨ë§ ì‹œ ë°”ë¼ë³´ë˜ ë°©í–¥ (ë°˜ê²© ëŒì§„ìš©)
        let samuraiCounterActive = false;     // ë°˜ê²© ëŒì§„ ì¤‘
        let samuraiCounterFrames = 0;         // ë°˜ê²© ëŒì§„ ë‚¨ì€ í”„ë ˆì„
        let samuraiCounterVx = 0;
        let samuraiCounterVy = 0;
        const SAMURAI_COUNTER_FRAMES = 14;    // ë°˜ê²© ëŒì§„ ì§€ì† í”„ë ˆì„
        const SAMURAI_COUNTER_SPEED = 20;     // ë°˜ê²© ëŒì§„ ì†ë„
        const SAMURAI_COUNTER_DMG = 50;       // ë°˜ê²© í”¼í•´
        const samuraiCounterHitIds = new Set();

        const playerSamuraiSlashes = {};      // ë‹¤ë¥¸ í”Œë ˆì´ì–´ ë² ê¸° ìƒíƒœ
        const playerParries = {};             // ë‹¤ë¥¸ í”Œë ˆì´ì–´ íŒ¨ë§ ìƒíƒœ

        // ========== ê²Œì„ ìƒíƒœ ==========
        const GAME_STATUS = {
            LOBBY: 'LOBBY',
            PLAYING: 'PLAYING'
        };

        const GAME_MODE = {
            NORMAL: 'NORMAL',      // ì¼ë°˜ ëª¨ë“œ (2ì¸ ì´ìƒ, ìµœí›„ 1ì¸ ìŠ¹ë¦¬)
            PRACTICE: 'PRACTICE'   // ì—°ìŠµ ëª¨ë“œ (1ì¸ ê°€ëŠ¥, í—ˆìˆ˜ì•„ë¹„, ì¦‰ì‹œ ë¶€í™œ)
        };

        let myPlayerId = null;
        let myNickname = null;
        let myClass = null;
        let isHost = false;
        let isReady = false;
        let gameStatus = GAME_STATUS.LOBBY;
        let gameMode = GAME_MODE.NORMAL;  // í˜„ì¬ ê²Œì„ ëª¨ë“œ

        const players = {};
        const keys = {};
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const PLAYER_SIZE = 30;

        // í—ˆìˆ˜ì•„ë¹„ (ì—°ìŠµ ëª¨ë“œ ì „ìš©)
        const DUMMY_ID = 'training_dummy';
        function createDummyData() {
            return {
                id: DUMMY_ID,
                nickname: 'í›ˆë ¨ìš© í—ˆìˆ˜ì•„ë¹„',
                x: 1000 - PLAYER_SIZE / 2,
                y: 1000 - PLAYER_SIZE / 2,
                health: 999999,
                maxHealth: 999999,
                color: '#888888',
                isSpectator: false,
                isDummy: true
            };
        }

        // ì¹´ë©”ë¼ ì˜¤í”„ì…‹
        let cameraX = 0;
        let cameraY = 0;

        // ê´€ì „ ì‹œìŠ¤í…œ
        let isSpectating = false;
        let spectateTargetId = null;
        let isAlive = true;

        // Rí‚¤ ê°•ì œ ì¢…ë£Œ ì‹œìŠ¤í…œ
        let rKeyPressStart = 0;
        let rKeyHolding = false;
        let forceStopProgress = 0; // 0~100%

        // ì „íˆ¬ ì‹œìŠ¤í…œ
        const bullets = []; // ëª¨ë“  ì´ì•Œ
        let lastAttackTime = 0;
        let skillCooldownEnd = 0;
        let isUsingSkill = false;
        let skillBulletCount = 0;
        let skillDirection = { x: 0, y: 0 };
        let lastSkillBullet = 0;

        // ëŒ€ì‰¬ ì‹œìŠ¤í…œ (ëŒì§„ ë©”ì»¤ë‹ˆì¦˜)
        let dashCooldownEnd = 0;
        const DASH_COOLDOWN = 3;
        let isDashing = false;
        let dashVx = 0;
        let dashVy = 0;
        let dashRemainFrames = 0;
        const DASH_TOTAL_FRAMES = 12;   // ëŒì§„ ì§€ì† í”„ë ˆì„
        // DASH_SPEEDëŠ” ì´ë™ì†ë„ ë¹„ë¡€ë¡œ performDashì—ì„œ ê³„ì‚° (ê¸°ì¤€: moveSpeed 5 â†’ speed 28)

        // íŒŒí‹°í´ (ëŒ€ì‰¬ ë¨¼ì§€/ì”ìƒ)
        const particles = [];
        const particleIds = new Set(); // ì¤‘ë³µ ìˆ˜ì‹  ë°©ì§€ìš©

        // íˆíŠ¸ ì´í™íŠ¸
        const hitEffects = [];

        // ì´ì•Œ ID ì¤‘ë³µ ë°©ì§€ìš©
        const bulletIds = new Set();

        // ëª¨ë“  í”Œë ˆì´ì–´ ìŠ¤ìœ™ ìƒíƒœ (playerId â†’ swingState)
        const playerSwings = {};
        // ëª¨ë“  í”Œë ˆì´ì–´ ì°Œë¥´ê¸° ìƒíƒœ (playerId â†’ stabState)
        const playerStabs = {};

        // ë§µ í¬ê¸°
        const MAP_W = 2000;
        const MAP_H = 2000;

        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜
        let mouseX = 0;
        let mouseY = 0;

        // ========== í™”ë©´ ì „í™˜ ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // ========== ë‹‰ë„¤ì„ ì…ë ¥ ==========
        document.getElementById('nicknameNextBtn').addEventListener('click', () => {
            const nickname = document.getElementById('nicknameInput').value.trim();
            if (!nickname) {
                document.getElementById('nicknameError').textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!';
                return;
            }
            myNickname = nickname;
            document.getElementById('myNickname').textContent = myNickname;
            showScreen('classScreen');
            renderClassSelection();
        });

        document.getElementById('nicknameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('nicknameNextBtn').click();
            }
        });

        // ========== ì§ì—… ì„ íƒ ìŠ¬ë¼ì´ë” ==========
        let currentClassIndex = 0;
        let classIds = [];

        function renderClassSelection() {
            const slider = document.getElementById('classSlider');
            const dotsContainer = document.getElementById('swiperDots');
            slider.innerHTML = '';
            dotsContainer.innerHTML = '';
            classIds = Object.keys(CLASSES);

            classIds.forEach((classId, index) => {
                const classData = CLASSES[classId];
                
                // ìŠ¬ë¼ì´ë“œ ìƒì„±
                const slide = document.createElement('div');
                slide.className = 'class-slide';
                slide.innerHTML = `
                    <div class="class-card">
                        <div class="class-icon">${classData.icon}</div>
                        <h3>${classData.name}</h3>
                        <p class="description">${classData.description}</p>
                        <div class="stats">
                            <div>âš¡ ì´ë™ì†ë„: ${classData.stats.moveSpeed}</div>
                            <div>âš”ï¸ ê³µê²©ë ¥: ${classData.id === 'samurai' ? '5~35 (ì°¨ì§•)' : classData.stats.attack}</div>
                            <div>â±ï¸ ê³µê²©ì†ë„: ${classData.stats.attackSpeed}/ì´ˆ</div>
                            <div>â¤ï¸ ì²´ë ¥: ${classData.stats.health}</div>
                        </div>
                    </div>
                `;
                slider.appendChild(slide);

                // ë„íŠ¸ ìƒì„±
                const dot = document.createElement('div');
                dot.className = 'swiper-dot' + (index === 0 ? ' active' : '');
                dot.addEventListener('click', () => goToSlide(index));
                dotsContainer.appendChild(dot);
            });

            // ì²« ì§ì—… ìë™ ì„ íƒ
            selectClassByIndex(0);

            // ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸
            document.getElementById('swiperPrev').addEventListener('click', prevSlide);
            document.getElementById('swiperNext').addEventListener('click', nextSlide);

            // í„°ì¹˜ ìŠ¤ì™€ì´í”„ ì§€ì›
            let touchStartX = 0;
            let touchEndX = 0;
            slider.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
            slider.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                if (touchStartX - touchEndX > 50) nextSlide();
                if (touchEndX - touchStartX > 50) prevSlide();
            });

            // í‚¤ë³´ë“œ í™”ì‚´í‘œ ì§€ì›
            document.addEventListener('keydown', function classKeyHandler(e) {
                if (document.getElementById('classScreen').classList.contains('active')) {
                    if (e.key === 'ArrowLeft') prevSlide();
                    if (e.key === 'ArrowRight') nextSlide();
                }
            });
        }

        function goToSlide(index) {
            currentClassIndex = index;
            const slider = document.getElementById('classSlider');
            slider.style.transform = `translateX(-${index * 100}%)`;
            
            // ë„íŠ¸ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.swiper-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });

            selectClassByIndex(index);
        }

        function prevSlide() {
            if (currentClassIndex > 0) goToSlide(currentClassIndex - 1);
        }

        function nextSlide() {
            if (currentClassIndex < classIds.length - 1) goToSlide(currentClassIndex + 1);
        }

        function selectClassByIndex(index) {
            myClass = classIds[index];
            document.getElementById('classSelectBtn').disabled = false;
        }

        document.getElementById('classSelectBtn').addEventListener('click', function() {
            if (!myClass) {
                document.getElementById('classError').textContent = 'ì§ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”!';
                return;
            }
            showScreen('roomScreen');
            startRoomListListener();
        });

        // ========== ë°© ëª©ë¡ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ==========
        let roomListListener = null;
        function startRoomListListener() {
            if (roomListListener) roomsRef.off('value', roomListListener);
            roomListListener = roomsRef.on('value', (snapshot) => {
                const allRooms = snapshot.val() || {};
                const listDiv = document.getElementById('roomList');
                listDiv.innerHTML = '';

                const lobbyRooms = Object.entries(allRooms).filter(([, r]) =>
                    r.gameState && r.gameState.status === GAME_STATUS.LOBBY
                );

                if (lobbyRooms.length === 0) {
                    listDiv.innerHTML = '<div class="room-empty">ëŒ€ê¸° ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }

                lobbyRooms.forEach(([roomId, room]) => {
                    const playerCount = room.players ? Object.keys(room.players).length : 0;
                    const hostName = room.gameState && room.gameState.hostName ? room.gameState.hostName : 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const item = document.createElement('div');
                    item.className = 'room-item';
                    item.innerHTML = `
                        <div class="room-info">
                            <div class="room-host">ğŸ‘‘ ${hostName}ì˜ ë°©</div>
                            <div class="room-count">${playerCount}ëª… ëŒ€ê¸° ì¤‘</div>
                        </div>
                        <div style="color: #00fff5; font-size: 20px;">â€º</div>
                    `;
                    item.addEventListener('click', () => {
                        stopRoomListListener();
                        joinRoom(roomId);
                    });
                    listDiv.appendChild(item);
                });
            });
        }

        function stopRoomListListener() {
            if (roomListListener) {
                roomsRef.off('value', roomListListener);
                roomListListener = null;
            }
        }

        // ========== ë°© ë§Œë“¤ê¸° ë²„íŠ¼ ==========
        document.getElementById('createRoomBtn').addEventListener('click', () => {
            stopRoomListListener();
            const roomId = 'room_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            joinRoom(roomId, true);
        });

        // ========== ë°© ì…ì¥ (ìƒì„± or ê¸°ì¡´) ==========
        function joinRoom(roomId, isCreating = false) {
            currentRoomId = roomId;
            initRoomRefs(roomId);
            joinLobby(isCreating);
        }

        // ========== ëŒ€ê¸°ì‹¤ ì…ì¥ ==========
        function joinLobby(isCreating = false) {
            myPlayerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // ê²Œì„ ìƒíƒœ í™•ì¸
            gameStateRef.once('value', (snapshot) => {
                const gameState = snapshot.val();
                
                // ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ë©´ ê´€ì „ ëª¨ë“œë¡œ ì…ì¥
                if (gameState && gameState.status === GAME_STATUS.PLAYING) {
                    isSpectating = true;
                    isAlive = false;

                    // Firebaseì— ê´€ì „ìë¡œ ë“±ë¡ (ìœ„ì¹˜ ì—†ì´)
                    const classData = CLASSES[myClass];
                    const spectatorData = {
                        id: myPlayerId,
                        nickname: myNickname,
                        class: myClass,
                        className: classData.name,
                        stats: classData.stats,
                        color: classData.color,
                        ready: false,
                        x: -9999,
                        y: -9999,
                        health: 0,
                        maxHealth: classData.stats.health,
                        isSpectator: true,
                        timestamp: Date.now()
                    };
                    playersRef.child(myPlayerId).set(spectatorData);
                    playersRef.child(myPlayerId).onDisconnect().remove();

                    // ê²Œì„ ì¢…ë£Œ ê°ì§€ â†’ ë¡œë¹„ë¡œ
                    gameStateRef.on('value', (snap) => {
                        const state = snap.val();
                        if (!state || state.status === GAME_STATUS.LOBBY) {
                            location.reload();
                        }
                    });

                    // ê²Œì„ í™”ë©´ìœ¼ë¡œ ì „í™˜ í›„ ê´€ì „ ì‹œì‘
                    gameStatus = GAME_STATUS.PLAYING;
                    showScreen('gameContainer');
                    document.getElementById('info').style.display = 'block';
                    document.getElementById('playerList').style.display = 'block';
                    document.getElementById('controls').style.display = 'block';
                    document.getElementById('myClass').textContent = CLASSES[myClass].name;

                    // í”Œë ˆì´ì–´ ê°ì§€ í›„ ê´€ì „ ëŒ€ìƒ ì„ íƒ
                    playersRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        for (let id in players) {
                            if (!data || !data[id]) delete players[id];
                        }
                        if (data) {
                            for (let id in data) players[id] = data[id];
                        }
                        updatePlayerList();
                        // ê´€ì „ ëŒ€ìƒì´ ì—†ê±°ë‚˜ ì‚¬ë¼ì¡Œìœ¼ë©´ ìƒˆë¡œ ì„ íƒ
                        if (!spectateTargetId || !players[spectateTargetId] || players[spectateTargetId].isSpectator) {
                            pickRandomSpectateTarget();
                        }
                    });

                    document.addEventListener('keydown', handleKeyDown);
                    document.addEventListener('keyup', handleKeyUp);
                    canvas.addEventListener('mousemove', handleMouseMove);
                    canvas.addEventListener('mousedown', handleMouseDown);
                    canvas.addEventListener('mouseup', handleMouseUp);
                    canvas.addEventListener('contextmenu', handleRightClick);
                    setupEffectListeners(); // ê´€ì „ìë„ ì´í™íŠ¸ ìˆ˜ì‹ 
                    gameLoop();
                    return;
                }
                
                // ëŒ€ê¸°ì‹¤ë¡œ ì…ì¥
                const classData = CLASSES[myClass];
                const playerData = {
                    id: myPlayerId,
                    nickname: myNickname,
                    class: myClass,
                    className: classData.name,
                    stats: classData.stats,
                    color: classData.color,
                    ready: false,
                    x: 0,
                    y: 0,
                    health: classData.stats.health,
                    maxHealth: classData.stats.health,
                    timestamp: Date.now()
                };
                
                playersRef.child(myPlayerId).set(playerData);
                playersRef.child(myPlayerId).onDisconnect().remove();
                
                // ë°© ë§Œë“¤ê¸°ë¡œ ì§„ì…í–ˆê±°ë‚˜ ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ë©´ ë°©ì¥
                if (isCreating) {
                    isHost = true;
                    gameStateRef.set({
                        status: GAME_STATUS.LOBBY,
                        hostId: myPlayerId,
                        hostName: myNickname
                    });
                    gameStateRef.onDisconnect().remove();
                    document.getElementById('hostIndicator').style.display = 'block';
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('practiceBtn').style.display = 'inline-block';
                }
                
                showScreen('lobbyScreen');
                // ëŒ€ê¸°ì‹¤ íƒ€ì´í‹€ì— ë°©ì¥ ì´ë¦„ í‘œì‹œ
                gameStateRef.once('value', (s) => {
                    const st = s.val();
                    const hostName = st && st.hostName ? st.hostName : myNickname;
                    document.getElementById('lobbyTitle').textContent = `ğŸ  ${hostName}ì˜ ë°©`;
                });
                setupLobbyListeners();
            });
        }

        // ========== ëŒ€ê¸°ì‹¤ ë¦¬ìŠ¤ë„ˆ ==========
        function setupLobbyListeners() {
            // í”Œë ˆì´ì–´ ëª©ë¡ ê°ì§€
            playersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                
                const listDiv = document.getElementById('lobbyPlayerList');
                listDiv.innerHTML = '';
                
                let readyCount = 0;
                let totalCount = 0;
                
                for (let id in data) {
                    const player = data[id];
                    totalCount++;
                    if (player.ready) readyCount++;
                    
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'lobby-player';
                    if (player.ready) playerDiv.classList.add('ready');
                    
                    playerDiv.innerHTML = `
                        <div class="lobby-player-info">
                            <div class="player-color" style="background: ${player.color}"></div>
                            <strong>${player.nickname}</strong>
                            ${id === myPlayerId ? '(ë‚˜)' : ''}
                            <span class="lobby-player-class">${player.className}</span>
                        </div>
                        <span class="lobby-player-status ${player.ready ? 'ready' : 'waiting'}">
                            ${player.ready ? 'âœ“ ì¤€ë¹„ì™„ë£Œ' : 'ëŒ€ê¸°ì¤‘'}
                        </span>
                    `;
                    listDiv.appendChild(playerDiv);
                }
                
                document.getElementById('lobbyPlayerCount').textContent = totalCount;
                
                if (isHost && totalCount > 0 && readyCount === totalCount) {
                    document.getElementById('startBtn').disabled = false;
                } else if (isHost) {
                    document.getElementById('startBtn').disabled = true;
                }
            });

            // â˜… íŒŒí‹°ì›ìš©: gameState ë³€ê²½ ê°ì§€ â†’ PLAYINGì´ ë˜ë©´ ê²Œì„ í™”ë©´ìœ¼ë¡œ ì „í™˜
            gameStateRef.on('value', (snapshot) => {
                const state = snapshot.val();
                if (!state) return;
                if (state.status === GAME_STATUS.PLAYING && gameStatus !== GAME_STATUS.PLAYING) {
                    // ìŠ¤í° ì¢Œí‘œê°€ Firebaseì— ë°˜ì˜ë  ë•Œê¹Œì§€ ì ê¹ ëŒ€ê¸° í›„ ì‹œì‘
                    playersRef.child(myPlayerId).once('value', (snap) => {
                        const me = snap.val();
                        if (me && me.x !== undefined && me.x !== 0) {
                            startGame();
                        } else {
                            // ì¢Œí‘œê°€ ì•„ì§ ì•ˆ ì™”ìœ¼ë©´ ì¬ì‹œë„
                            setTimeout(() => {
                                playersRef.child(myPlayerId).once('value', (snap2) => {
                                    startGame();
                                });
                            }, 300);
                        }
                    });
                }
            });
        }

        // ========== ì¤€ë¹„ ì™„ë£Œ ë²„íŠ¼ ==========
        document.getElementById('readyBtn').addEventListener('click', () => {
            isReady = !isReady;
            playersRef.child(myPlayerId).update({ ready: isReady });
            document.getElementById('readyBtn').textContent = isReady ? 'ì¤€ë¹„ ì·¨ì†Œ' : 'ì¤€ë¹„ ì™„ë£Œ';
            document.getElementById('readyBtn').style.background = isReady ? '#ff9800' : '#00fff5';
        });

        // ========== ê²Œì„ ì‹œì‘ ë²„íŠ¼ (ì¼ë°˜ ëª¨ë“œ: 2ì¸ ì´ìƒ) ==========
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!isHost) return;
            playersRef.once('value', (snapshot) => {
                const allPlayers = snapshot.val();
                const playerCount = Object.keys(allPlayers || {}).length;
                if (playerCount < 2) {
                    document.getElementById('lobbyError').textContent = 'ì¼ë°˜ ê²Œì„ì€ 2ì¸ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤. 1ì¸ì€ ì—°ìŠµ ëª¨ë“œë¥¼ ì´ìš©í•˜ì„¸ìš”.';
                    return;
                }
                document.getElementById('lobbyError').textContent = '';
                gameMode = GAME_MODE.NORMAL;
                startGameSession(allPlayers);
            });
        });

        // ========== ì—°ìŠµ ëª¨ë“œ ë²„íŠ¼ ==========
        document.getElementById('practiceBtn').addEventListener('click', () => {
            if (!isHost) return;
            playersRef.once('value', (snapshot) => {
                const allPlayers = snapshot.val();
                gameMode = GAME_MODE.PRACTICE;
                startGameSession(allPlayers);
            });
        });

        // ========== ê²Œì„ ì„¸ì…˜ ì‹œì‘ ê³µí†µ ë¡œì§ ==========
        function startGameSession(allPlayers) {
            const updates = {};
            for (let id in allPlayers) {
                const spawnX = 100 + Math.random() * 1800;
                const spawnY = 100 + Math.random() * 1800;
                updates[id + '/x'] = spawnX;
                updates[id + '/y'] = spawnY;
                updates[id + '/ready'] = false;
            }

            // ì—°ìŠµ ëª¨ë“œë©´ í—ˆìˆ˜ì•„ë¹„ ì¶”ê°€
            if (gameMode === GAME_MODE.PRACTICE) {
                updates[DUMMY_ID] = createDummyData();
            }

            playersRef.update(updates, () => {
                gameStateRef.update({
                    status: GAME_STATUS.PLAYING,
                    mode: gameMode,
                    startTime: Date.now()
                });
                startGame();
            });
        }

        // ========== ê²Œì„ ì‹œì‘ ==========
        function startGame() {
            if (gameStatus === GAME_STATUS.PLAYING) return;
            gameStatus = GAME_STATUS.PLAYING;

            // ëŒ€ê¸°ì‹¤ ë¦¬ìŠ¤ë„ˆ í•´ì œ
            playersRef.off();
            gameStateRef.off();

            // â˜… ë‚´ ì´ì „ ì„¸ì…˜ ì”ì—¬ ë°ì´í„° ì •ë¦¬ (ë¹„ë™ê¸°, ë¸”ë¡œí‚¹ ì—†ìŒ)
            Promise.all([
                bulletsRef.orderByChild('ownerId').equalTo(myPlayerId).once('value').then(s => s.forEach(c => c.ref.remove())),
                particlesRef.orderByChild('ownerId').equalTo(myPlayerId).once('value').then(s => s.forEach(c => c.ref.remove())),
                swingsRef.child(myPlayerId).remove()
            ]).catch(() => {}); // ì—ëŸ¬ ë¬´ì‹œ

            showScreen('gameContainer');
            document.getElementById('info').style.display = 'block';
            document.getElementById('playerList').style.display = 'block';
            document.getElementById('controls').style.display = 'block';
            document.getElementById('myClass').textContent = CLASSES[myClass].name;
            isAlive = true;

            // â˜… ì¢…ë£Œ/ìƒˆë¡œê³ ì¹¨ ì‹œ ìºë¦­í„°(+ì—°ìŠµ ëª¨ë“œëŠ” ë°© ì „ì²´) ì œê±°
            if (gameMode === GAME_MODE.PRACTICE && currentRoomId) {
                // ì—°ìŠµ ëª¨ë“œ: ì ‘ì† ëŠê¸°ë©´ ë°© ì „ì²´ ì‚­ì œ
                database.ref('rooms/' + currentRoomId).onDisconnect().remove();
                window.addEventListener('beforeunload', () => {
                    database.ref('rooms/' + currentRoomId).remove();
                });
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        database.ref('rooms/' + currentRoomId).remove();
                    }
                });
            } else {
                playersRef.child(myPlayerId).onDisconnect().remove();
                window.addEventListener('beforeunload', () => {
                    playersRef.child(myPlayerId).remove();
                });
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        playersRef.child(myPlayerId).remove();
                    }
                });
            }

            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);

            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('contextmenu', handleRightClick);

            // í”Œë ˆì´ì–´ ì‹¤ì‹œê°„ ë™ê¸°í™”
            playersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                for (let id in players) {
                    if (!data || !data[id]) delete players[id];
                }
                if (data) {
                    for (let id in data) players[id] = data[id];
                }
                if ((isSpectating || !isAlive) && (!spectateTargetId || !players[spectateTargetId] || players[spectateTargetId].isSpectator)) {
                    pickRandomSpectateTarget();
                }
                updatePlayerList();
            });

            // ë‚´ HP ë³€ê²½ ê°ì§€ â†’ ì‚¬ë§ ì²˜ë¦¬ / ì—°ìŠµ ëª¨ë“œ ë¶€í™œ
            playersRef.child(myPlayerId).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                if (data.health <= 0 && isAlive) {
                    isAlive = false;
                    cancelSamuraiCharge(); // ì‚¬ë¬´ë¼ì´ ì°¨ì§• ì·¨ì†Œ

                    if (gameMode === GAME_MODE.PRACTICE) {
                        // ì—°ìŠµ ëª¨ë“œ: 1ì´ˆ í›„ ë¶€í™œ
                        setTimeout(() => {
                            const respawnX = 100 + Math.random() * 1800;
                            const respawnY = 100 + Math.random() * 1800;
                            const maxHp = myClass === 'blacksmith' ? CLASSES.blacksmith.stats.health : CLASSES[myClass].stats.health;
                            playersRef.child(myPlayerId).update({
                                x: respawnX,
                                y: respawnY,
                                health: maxHp,
                                isSpectator: false
                            });
                            isAlive = true;
                            isSpectating = false;
                            document.getElementById('spectateHint').style.display = 'none';
                        }, 1000);
                    } else {
                        // ì¼ë°˜ ëª¨ë“œ: ê´€ì „
                        isSpectating = true;
                        pickRandomSpectateTarget();
                        document.getElementById('spectateHint').style.display = 'block';
                    }
                }
            });

            // ë‹¤ë¥¸ í”Œë ˆì´ì–´ ì´ì•Œ/íŒŒí‹°í´/ì´í™íŠ¸ ìˆ˜ì‹  (ê³µí†µ)
            setupEffectListeners();

            // ê²Œì„ ê°•ì œì¢…ë£Œ ê°ì§€ + ê²Œì„ ëª¨ë“œ ë™ê¸°í™”
            gameStateRef.on('value', (snapshot) => {
                const state = snapshot.val();
                if (!state || state.status === GAME_STATUS.LOBBY) {
                    location.reload();
                    return;
                }
                // ê²Œì„ ëª¨ë“œ ë™ê¸°í™”
                if (state.mode) gameMode = state.mode;
            });

            // í”Œë ˆì´ì–´ ìˆ˜ ê°ì§€ â†’ ìŠ¹ë¦¬ ì¡°ê±´ ì²´í¬ (ì¼ë°˜ ëª¨ë“œë§Œ)
            playersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (gameMode !== GAME_MODE.NORMAL) return;
                if (!data) return;

                const alivePlayers = Object.keys(data).filter(id =>
                    id !== DUMMY_ID && !data[id].isSpectator && data[id].health > 0
                );

                // 2ì¸ ì´ìƒìœ¼ë¡œ ì‹œì‘ â†’ ìµœí›„ 1ì¸ ë‚¨ìœ¼ë©´ ìŠ¹ë¦¬
                if (alivePlayers.length === 1 && Object.keys(data).filter(i => i !== DUMMY_ID).length >= 2) {
                    const winnerId = alivePlayers[0];
                    const winner = data[winnerId];
                    showVictoryScreen(winner.nickname);
                }
            });

            // ê²Œì„ ë£¨í”„ ì‹œì‘
            gameLoop();
        }

        // ========== ì´í™íŠ¸ Firebase ë¦¬ìŠ¤ë„ˆ (í”Œë ˆì´ì–´/ê´€ì „ì ê³µí†µ) ==========
        function setupEffectListeners() {
            // â”€â”€ ì´ì•Œ ìˆ˜ì‹  (ìœ„ì¹˜ ê²½ê³¼ì‹œê°„ ë³´ì •) â”€â”€
            bulletsRef.on('child_added', (snapshot) => {
                const b = snapshot.val();
                if (!b || b.ownerId === myPlayerId) return;
                if (bulletIds.has(b.id)) return;
                const elapsed = (Date.now() - b.createdAt) / 1000;
                if (elapsed * 1000 > b.maxLifetime + 500) return;
                const frames = elapsed * 60;
                b.x += b.vx * frames;
                b.y += b.vy * frames;
                bulletIds.add(b.id);
                bullets.push(b);
                console.log(`[ì´ì•Œ ìˆ˜ì‹ ] from ${b.ownerId}, elapsed: ${elapsed.toFixed(2)}s`);
            });
            bulletsRef.on('child_removed', (snapshot) => {
                const b = snapshot.val();
                if (!b) return;
                bulletIds.delete(b.id);
                const idx = bullets.findIndex(x => x.id === b.id);
                if (idx !== -1) bullets.splice(idx, 1);
            });

            // â”€â”€ íŒŒí‹°í´ ìˆ˜ì‹  (ê²½ê³¼ì‹œê°„ ë³´ì •) â”€â”€
            particlesRef.on('child_added', (snapshot) => {
                const p = snapshot.val();
                if (!p || p.ownerId === myPlayerId) return;
                if (particleIds.has(p.id)) return;
                const elapsed = (Date.now() - p.createdAt) / 1000;
                const framesElapsed = Math.min(30, elapsed * 60);
                p.life = Math.max(0, 1.0 - p.decay * framesElapsed);
                if (p.life <= 0) return;
                p.x += p.vx * framesElapsed;
                p.y += p.vy * framesElapsed;
                particleIds.add(p.id);
                particles.push(p);
            });
            particlesRef.on('child_removed', (snapshot) => {
                const p = snapshot.val();
                if (!p) return;
                particleIds.delete(p.id);
                const idx = particles.findIndex(x => x.id === p.id);
                if (idx !== -1) particles.splice(idx, 1);
            });

            // â”€â”€ íˆíŠ¸ ì´í™íŠ¸ ìˆ˜ì‹  â”€â”€
            hitEffectsRef.on('child_added', (snapshot) => {
                const ef = snapshot.val();
                if (!ef) return;
                if (ef.ownerId === myPlayerId) return; // ë°œì‚¬ìëŠ” ì´ë¯¸ ë¡œì»¬ ìƒì„±
                if (Date.now() - ef.createdAt > 2000) return;
                _addHitEffect(ef);
                // í”¼ê²© í”Œë˜ì‹œ (ë‚´ê°€ ë§ì€ ìœ„ì¹˜ ê·¼ì²˜ë©´)
                if (players[myPlayerId]) {
                    const me = players[myPlayerId];
                    const dx = ef.x - (me.x + PLAYER_SIZE / 2);
                    const dy = ef.y - (me.y + PLAYER_SIZE / 2);
                    if (Math.sqrt(dx*dx + dy*dy) < PLAYER_SIZE) {
                        flashScreen(ef.isFatal ? '#ff000055' : '#ff880033', ef.isFatal ? 300 : 150);
                    }
                }
            });

            // â”€â”€ ì›Œë¦¬ì–´ ìŠ¤ìœ™ ìˆ˜ì‹  â”€â”€
            swingsRef.on('child_added', (snapshot) => {
                const s = snapshot.val();
                if (!s || s.ownerId === myPlayerId) return;
                if (Date.now() - s.createdAt > 2000) return;
                playerSwings[s.ownerId] = {
                    ...s,
                    frames: s.totalFrames,
                    angle: s.dir - s.arc / 2
                };
            });
            swingsRef.on('child_removed', (snapshot) => {
                const s = snapshot.val();
                if (s) delete playerSwings[s.ownerId];
            });

            // â”€â”€ ì–´ìŒ”ì‹  ì°Œë¥´ê¸° ìˆ˜ì‹  â”€â”€
            stabsRef.on('child_added', (snapshot) => {
                const s = snapshot.val();
                if (!s || s.ownerId === myPlayerId) return;
                if (Date.now() - s.createdAt > 2000) return;
                playerStabs[s.ownerId] = { ...s, frames: s.totalFrames };
            });
            stabsRef.on('child_removed', (snapshot) => {
                const s = snapshot.val();
                if (s) delete playerStabs[s.ownerId];
            });

            // â”€â”€ ì–´ìŒ”ì‹  ì—°ê¸° ìˆ˜ì‹  â”€â”€
            smokesRef.on('child_added', (snapshot) => {
                const s = snapshot.val();
                if (!s || s.ownerId === myPlayerId) return;
                // forge_ ì ‘ë‘ì‚¬ëŠ” ê°•í™” ì‹ í˜¸ â€” particlesRefë¡œ ì´ë¯¸ íŒŒí‹°í´ ê³µìœ ë˜ë¯€ë¡œ ì—¬ê¸°ì„  ë¬´ì‹œ
                if (snapshot.key && snapshot.key.startsWith('forge_')) return;
                if (Date.now() - s.createdAt > 3000) return;
                spawnSmokeEffect(s.x, s.y);
            });

            // â”€â”€ ëŒ€ì¥ì¥ì´ ë§ì¹˜ ê³µê²© ìˆ˜ì‹  â”€â”€
            smithHammersRef.on('child_added', (snapshot) => {
                const h = snapshot.val();
                if (!h || h.ownerId === myPlayerId) return;
                if (Date.now() - h.createdAt > 2000) return;
                playerHammers[h.ownerId] = { ...h, frames: h.totalFrames };
            });
            smithHammersRef.on('child_removed', (snapshot) => {
                const h = snapshot.val();
                if (h) delete playerHammers[h.ownerId];
            });

            // â”€â”€ ì‚¬ë¬´ë¼ì´ íŒ¨ë§ íˆíŠ¸ ì‹ í˜¸ ìˆ˜ì‹  (í”¼ê²©ì ë³¸ì¸ë§Œ ì²˜ë¦¬) â”€â”€
            parryHitsRef.on('child_added', (snapshot) => {
                const d = snapshot.val();
                if (!d || d.targetId !== myPlayerId) return;
                if (Date.now() - d.createdAt > 1500) return;
                _checkAndTriggerParry();
            });
            samuraiSlashesRef.on('child_added', (snapshot) => {
                const s = snapshot.val();
                if (!s || s.ownerId === myPlayerId) return;
                if (Date.now() - s.createdAt > 2000) return;
                const key = snapshot.key;
                playerSamuraiSlashes[key] = {
                    ...s,
                    frames: s.totalFrames || SAMURAI_SLASH_TOTAL,
                    progress: 0,
                    type: s.type || 'slash'
                };
                console.log(`[ì‚¬ë¬´ë¼ì´ ìŠ¬ë˜ì‹œ ìˆ˜ì‹ ] from ${s.ownerId}, key: ${key}`);
            });
            samuraiSlashesRef.on('child_removed', (snapshot) => {
                delete playerSamuraiSlashes[snapshot.key];
            });
        }

        // ========== ìŠ¹ë¦¬ í™”ë©´ ==========
        function showVictoryScreen(winnerName) {
            // ëŒ€ì¥ì¥ì´ ê°•í™” ì´ˆê¸°í™” (ê²Œì„ ì¢…ë£Œ ì‹œ)
            smithEnhanceLevel = 0;
            smithForging = false;
            CLASSES.blacksmith.stats = { moveSpeed: 4, attack: 10, attackSpeed: 0.5, health: 80 };

            const isWinner = players[myPlayerId] && players[myPlayerId].health > 0 && !players[myPlayerId].isSpectator;
            const msg = isWinner ? `ğŸ‰ ìŠ¹ë¦¬! ğŸ‰` : `ğŸ† ${winnerName} ë‹˜ì´ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!`;
            
            // í™”ë©´ ì¤‘ì•™ì— ë©”ì‹œì§€
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = isWinner ? '#ffd700' : '#00fff5';
            ctx.font = 'bold 48px Malgun Gothic';
            ctx.textAlign = 'center';
            ctx.fillText(msg, canvas.width / 2, canvas.height / 2);

            // 3ì´ˆ í›„ ë°© ì „ì²´ ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                if (currentRoomId) database.ref('rooms/' + currentRoomId).remove();
                location.reload();
            }, 3000);
        }

        function handleKeyDown(e) {
            const key = e.key.toLowerCase();
            keys[key] = true;
            
            // Shift ëŒ€ì‰¬
            if (key === 'shift' && !keys['shift_pressed']) {
                keys['shift_pressed'] = true;
                if (!isSpectating && isAlive) {
                    // ì–´ìŒ”ì‹  ì€ì‹  ì¤‘ ëŒ€ì‰¬ ì‹œ ì€ì‹  í•´ì œ
                    if (myClass === 'assassin' && assassinStealthActive) {
                        assassinStealthActive = false;
                        playersRef.child(myPlayerId).update({ stealthed: false });
                    }
                    performDash();
                }
            }
            
            // Rí‚¤ í™€ë“œ ì‹œì‘ (ëˆ„êµ¬ë‚˜ 3ì´ˆ í™€ë“œ ì‹œ ê°•ì œì¢…ë£Œ)
            if (key === 'r' && gameStatus === GAME_STATUS.PLAYING && !rKeyHolding) {
                rKeyHolding = true;
                rKeyPressStart = Date.now();
            }
        }

        function handleKeyUp(e) {
            const key = e.key.toLowerCase();
            keys[key] = false;
            
            if (key === 'shift') {
                keys['shift_pressed'] = false;
            }

            // Rí‚¤ ë—Œ â†’ ì´ˆê¸°í™”
            if (key === 'r') {
                rKeyHolding = false;
                rKeyPressStart = 0;
                forceStopProgress = 0;
            }
        }

        // ========== ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ==========
        function handleMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
        }

        // â”€â”€ ì‚¬ë¬´ë¼ì´ ì°¨ì§• ì·¨ì†Œ (ì£½ìŒ/íŒ¨ë§ ë“±) â”€â”€
        function cancelSamuraiCharge() {
            if (!samuraiCharging) return;
            samuraiCharging = false;
            if (myPlayerId) playersRef.child(myPlayerId).update({ samuraiCharging: false });
        }

        // â”€â”€ ì‚¬ë¬´ë¼ì´ ì°¨ì§• ë°œì‚¬ ê³µí†µ í•¨ìˆ˜ â”€â”€
        function fireSamuraiThrust() {
            if (!samuraiCharging) return;
            samuraiCharging = false;
            // Firebase ì°¨ì§• ìƒíƒœ í•´ì œ
            if (myPlayerId) playersRef.child(myPlayerId).update({ samuraiCharging: false });
            if (samuraiSlashActive || samuraiParryActive || samuraiCounterActive) return;
            if (!myPlayerId || !players[myPlayerId]) return;
            const now = Date.now();
            const chargedMs = Math.min(now - samuraiChargeStart, SAMURAI_MAX_CHARGE);
            // ë ˆë²¨ ê²°ì •
            let lvl = SAMURAI_CHARGE_LEVELS[0];
            for (const l of SAMURAI_CHARGE_LEVELS) {
                if (chargedMs >= l.minTime) lvl = l;
            }
            samuraiCurrentLevel = lvl;
            // â˜… ë°œì‚¬ ìˆœê°„ì˜ ë§ˆìš°ìŠ¤ ë°©í–¥ìœ¼ë¡œ ì¬ê³„ì‚°
            const myPlayer = players[myPlayerId];
            const worldMouseX = mouseX + cameraX;
            const worldMouseY = mouseY + cameraY;
            const fdx = worldMouseX - (myPlayer.x + PLAYER_SIZE / 2);
            const fdy = worldMouseY - (myPlayer.y + PLAYER_SIZE / 2);
            samuraiSlashDir = Math.atan2(fdy, fdx);
            samuraiSlashProgress = 0;
            samuraiSlashActive = true;
            samuraiSlashFrames = SAMURAI_SLASH_TOTAL;
            samuraiSlashHitIds.clear();
            samuraiSlashDashFrames = lvl.dashFrames;
            samuraiSlashDashVx = Math.cos(samuraiSlashDir) * lvl.dashSpeed;
            samuraiSlashDashVy = Math.sin(samuraiSlashDir) * lvl.dashSpeed;
            const slashData = {
                ownerId: myPlayerId,
                dir: samuraiSlashDir,
                totalFrames: SAMURAI_SLASH_TOTAL,
                thrustLength: lvl.length,
                thrustWidth: lvl.width,
                createdAt: now
            };
            samuraiSlashesRef.child(myPlayerId).set(slashData);
            playerSamuraiSlashes[myPlayerId] = { ...slashData, frames: SAMURAI_SLASH_TOTAL, progress: 0 };
            lastAttackTime = now;
        }

        function handleMouseDown(e) {
            if (e.button !== 0) return;
            const rect = canvas.getBoundingClientRect();
            if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) return;

            if (isSpectating || !isAlive) { switchSpectateTarget(1); return; }
            if (!myPlayerId || !players[myPlayerId]) return;
            const now = Date.now();

            if (myClass === 'samurai') {
                // ì‚¬ë¬´ë¼ì´: ëˆ„ë¥´ëŠ” ìˆœê°„ ì°¨ì§• ì‹œì‘
                if (samuraiSlashActive || samuraiParryActive || samuraiCounterActive) return;
                const stats = CLASSES[myClass].stats;
                if (now - lastAttackTime < 1000 / stats.attackSpeed) return;
                const myPlayer = players[myPlayerId];
                const worldMouseX = mouseX + cameraX;
                const worldMouseY = mouseY + cameraY;
                const dx = worldMouseX - (myPlayer.x + PLAYER_SIZE / 2);
                const dy = worldMouseY - (myPlayer.y + PLAYER_SIZE / 2);
                samuraiChargeDir = Math.atan2(dy, dx);
                samuraiCharging = true;
                samuraiChargeStart = now;
                // Firebaseì— ì°¨ì§• ìƒíƒœ ê³µìœ 
                playersRef.child(myPlayerId).update({ samuraiCharging: true, samuraiChargeStart: now });
                // íƒ€ì´ë¨¸ ì—†ìŒ - ë§ˆìš°ìŠ¤ë¥¼ ë—„ ë•Œë§Œ ë°œì‚¬ (í’€ì°¨ì§• ìœ ì§€ ê°€ëŠ¥)
                return;
            }

            // ì‚¬ë¬´ë¼ì´ê°€ ì•„ë‹Œ ì§ì—…ì€ ê¸°ì¡´ í´ë¦­ ë¡œì§ ê·¸ëŒ€ë¡œ
            const stats = CLASSES[myClass].stats;
            const attackCooldown = 1000 / stats.attackSpeed;
            if (now - lastAttackTime < attackCooldown) return;

            if (myClass === 'warrior') {
                if (warriorSwingActive) return;
                const myPlayer = players[myPlayerId];
                const worldMouseX = mouseX + cameraX;
                const worldMouseY = mouseY + cameraY;
                const dx = worldMouseX - (myPlayer.x + PLAYER_SIZE / 2);
                const dy = worldMouseY - (myPlayer.y + PLAYER_SIZE / 2);
                warriorSwingDir = Math.atan2(dy, dx);
                warriorSwingActive = true;
                warriorSwingFrames = WARRIOR_SWING_TOTAL;
                swingHitIds.clear();
                if (warriorSpinReady) {
                    warriorSpinReady = false;
                    _currentSwingArc = WARRIOR_SPIN_ARC;
                    _currentSwingRange = WARRIOR_SPIN_RANGE;
                } else {
                    _currentSwingArc = WARRIOR_SWING_ARC;
                    _currentSwingRange = WARRIOR_SWING_RANGE;
                }
                const swingData = {
                    ownerId: myPlayerId,
                    dir: warriorSwingDir,
                    arc: _currentSwingArc,
                    range: _currentSwingRange,
                    totalFrames: WARRIOR_SWING_TOTAL,
                    createdAt: Date.now()
                };
                swingsRef.child(myPlayerId).set(swingData);
                playerSwings[myPlayerId] = { ...swingData, frames: WARRIOR_SWING_TOTAL, angle: warriorSwingDir - _currentSwingArc / 2 };
                lastAttackTime = now;
            } else if (myClass === 'assassin') {
                if (assassinStealthActive) {
                    assassinStealthActive = false;
                    playersRef.child(myPlayerId).update({ stealthed: false });
                }
                if (assassinStabActive) return;
                const myPlayer = players[myPlayerId];
                const worldMouseX = mouseX + cameraX;
                const worldMouseY = mouseY + cameraY;
                const dx = worldMouseX - (myPlayer.x + PLAYER_SIZE / 2);
                const dy = worldMouseY - (myPlayer.y + PLAYER_SIZE / 2);
                assassinStabDir = Math.atan2(dy, dx);
                assassinStabActive = true;
                assassinStabFrames = ASSASSIN_STAB_TOTAL;
                assassinStabHit = false;
                const stabData = {
                    ownerId: myPlayerId,
                    x: myPlayer.x + PLAYER_SIZE / 2,
                    y: myPlayer.y + PLAYER_SIZE / 2,
                    dir: assassinStabDir,
                    totalFrames: ASSASSIN_STAB_TOTAL,
                    createdAt: now
                };
                stabsRef.child(myPlayerId).set(stabData);
                playerStabs[myPlayerId] = { ...stabData, frames: ASSASSIN_STAB_TOTAL };
                lastAttackTime = now;
            } else if (myClass === 'blacksmith') {
                if (smithForging || smithHammerActive) return;
                const myPlayer = players[myPlayerId];
                const worldMouseX = mouseX + cameraX;
                const worldMouseY = mouseY + cameraY;
                const dx = worldMouseX - (myPlayer.x + PLAYER_SIZE / 2);
                const dy = worldMouseY - (myPlayer.y + PLAYER_SIZE / 2);
                smithHammerDir = Math.atan2(dy, dx);
                smithHammerActive = true;
                smithHammerFrames = SMITH_HAMMER_TOTAL;
                smithHammerHit = false;
                smithHammerHitIds.clear();
                const hammerData = {
                    ownerId: myPlayerId,
                    x: myPlayer.x + PLAYER_SIZE / 2,
                    y: myPlayer.y + PLAYER_SIZE / 2,
                    dir: smithHammerDir,
                    totalFrames: SMITH_HAMMER_TOTAL,
                    createdAt: now,
                    enhanceLevel: smithEnhanceLevel
                };
                smithHammersRef.child(myPlayerId).set(hammerData);
                playerHammers[myPlayerId] = { ...hammerData, frames: SMITH_HAMMER_TOTAL };
                lastAttackTime = now;
            } else {
                shootBullet(mouseX, mouseY);
                lastAttackTime = now;
            }
        }

        function handleMouseUp(e) {
            if (e.button !== 0) return;
            if (myClass === 'samurai' && samuraiCharging) {
                fireSamuraiThrust();
            }
        }
        // ìº”ë²„ìŠ¤ ë°–ì—ì„œ ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë„ ì°¨ì§• ë°œì‚¬/ì·¨ì†Œ ì²˜ë¦¬
        window.addEventListener('mouseup', (e) => {
            if (e.button !== 0) return;
            if (myClass === 'samurai' && samuraiCharging) {
                fireSamuraiThrust();
            }
        });

        function handleRightClick(e) {
            e.preventDefault();
            // ìº”ë²„ìŠ¤ ë²”ìœ„ ë°– í´ë¦­ ë¬´ì‹œ
            const rect = canvas.getBoundingClientRect();
            if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) return;

            if (isSpectating || !isAlive) { switchSpectateTarget(-1); return; }
            if (!myPlayerId || !players[myPlayerId]) return;
            if (isUsingSkill) return;
            const now = Date.now();
            if (now < skillCooldownEnd) return;

            if (myClass === 'warrior') {
                // ì›Œë¦¬ì–´ ìŠ¤í‚¬: 3ì´ˆ ë°©ì–´ + ì´ë™ì†ë„ ì¦ê°€ + ë‹¤ìŒ íšŒì „ ê³µê²© ì¤€ë¹„
                warriorSkillActive = true;
                warriorSkillEnd = now + 3000;
                warriorSpinReady = true;
                skillCooldownEnd = now + CLASSES.warrior.skill.cooldown * 1000;
                // Firebaseì— ìŠ¤í‚¬ ìƒíƒœ ê³µìœ 
                playersRef.child(myPlayerId).update({ warriorSkillActive: true });
                setTimeout(() => {
                    warriorSkillActive = false;
                    warriorSpinReady = false;
                    playersRef.child(myPlayerId).update({ warriorSkillActive: false });
                }, 3000);
            } else if (myClass === 'assassin') {
                // ì–´ìŒ”ì‹  ìŠ¤í‚¬: ì—°ê¸°ì™€ í•¨ê»˜ ì€ì‹  ëŒì…
                assassinStealthActive = true;
                assassinStealthEnd = now + 3000; // ìµœëŒ€ 3ì´ˆ ì€ì‹ 
                skillCooldownEnd = now + CLASSES.assassin.skill.cooldown * 1000;
                // Firebaseì— ì€ì‹  ìƒíƒœ ê³µìœ 
                playersRef.child(myPlayerId).update({ stealthed: true });
                // ì—°ê¸° ì´í™íŠ¸ ë¡œì»¬ ìƒì„± + Firebase ê³µìœ 
                const myPlayer = players[myPlayerId];
                spawnSmokeEffect(myPlayer.x, myPlayer.y);
                const smokeData = {
                    ownerId: myPlayerId,
                    x: myPlayer.x,
                    y: myPlayer.y,
                    createdAt: now
                };
                smokesRef.child(myPlayerId).set(smokeData);
                setTimeout(() => smokesRef.child(myPlayerId).remove(), 3000);
            } else if (myClass === 'samurai') {
                // ì‚¬ë¬´ë¼ì´ íŒ¨ë§: 1ì´ˆ ê²½ì§ + ê³µê²© ë¬´íš¨í™”, ë§ìœ¼ë©´ ë°˜ê²© ëŒì§„
                if (samuraiParryActive || samuraiCounterActive || samuraiSlashActive) return;
                cancelSamuraiCharge(); // ì°¨ì§• ì¤‘ì´ë©´ ì·¨ì†Œ
                samuraiParryActive = true;
                samuraiParryHit = false;
                samuraiParryEnd = now + 1000;
                skillCooldownEnd = now + CLASSES.samurai.skill.cooldown * 1000;
                // íŒ¨ë§ ë°©í–¥ = ë§ˆìš°ìŠ¤ ë°©í–¥
                const myPlayer = players[myPlayerId];
                const worldMouseX = mouseX + cameraX;
                const worldMouseY = mouseY + cameraY;
                const pdx = worldMouseX - (myPlayer.x + PLAYER_SIZE / 2);
                const pdy = worldMouseY - (myPlayer.y + PLAYER_SIZE / 2);
                samuraiParryDir = Math.atan2(pdy, pdx);
                // Firebaseì— íŒ¨ë§ ìƒíƒœ ê³µìœ 
                playersRef.child(myPlayerId).update({ samuraiParrying: true });
                samuraiSlashesRef.child('parry_' + myPlayerId).set({
                    ownerId: myPlayerId, type: 'parry', createdAt: now
                });
                // 1ì´ˆ í›„ íŒ¨ë§ ì¢…ë£Œ
                setTimeout(() => {
                    if (!samuraiParryActive) return;
                    samuraiParryActive = false;
                    playersRef.child(myPlayerId).update({ samuraiParrying: false });
                    samuraiSlashesRef.child('parry_' + myPlayerId).remove();
                    if (samuraiParryHit) {
                        _startSamuraiCounter();
                    }
                }, 1000);
            } else if (myClass === 'blacksmith') {
                // ëŒ€ì¥ì¥ì´ ìŠ¤í‚¬: ê°•í™” - 2ì´ˆ ê²½ì§ í›„ ëŠ¥ë ¥ì¹˜ ìƒìŠ¹
                if (smithForging || smithHammerActive) return;
                smithForging = true;
                smithForgeEnd = now + 2000;
                skillCooldownEnd = now + CLASSES.blacksmith.skill.cooldown * 1000;
                // Firebaseì— ê°•í™” ìƒíƒœ ê³µìœ  (ê²½ì§ ì¤‘ í‘œì‹œ)
                playersRef.child(myPlayerId).update({ smithForging: true });
                // ëª¨ë£¨ ë‘ë“œë¦¬ëŠ” ì´í™íŠ¸ ê³µìœ 
                const myPlayer = players[myPlayerId];
                const forgeData = {
                    ownerId: myPlayerId,
                    x: myPlayer.x + PLAYER_SIZE / 2,
                    y: myPlayer.y + PLAYER_SIZE / 2,
                    createdAt: now
                };
                smokesRef.child('forge_' + myPlayerId).set(forgeData);
                setTimeout(() => smokesRef.child('forge_' + myPlayerId).remove(), 2000);
                // 1.5ì´ˆ í›„ ê²½ì§ í•´ì œ + ëŠ¥ë ¥ì¹˜ ìƒìŠ¹
                setTimeout(() => {
                    smithForging = false;
                    smithEnhanceLevel++;
                    // í˜„ì¬ ëŠ¥ë ¥ì¹˜ì— ê°•í™” ì ìš© (ë§¤ ê°•í™”ë§ˆë‹¤ +0.5/+5/+0.25 ê³ ì • ì¦ê°€)
                    const cur = CLASSES.blacksmith.stats;
                    const newMoveSpeed = cur.moveSpeed + 0.5;
                    const newAttack = cur.attack + 5;
                    const newAttackSpeed = cur.attackSpeed + 0.25;
                    // ì²´ë ¥ì€ í˜„ì¬ ì²´ë ¥ + 20 (ìµœëŒ€ì²´ë ¥ë„ +10 ì¦ê°€, í’€í”¼ë¡œ ì±„ì›Œì§€ì§€ ì•ŠìŒ)
                    const curHp = players[myPlayerId] ? players[myPlayerId].health : cur.health;
                    const newMaxHp = cur.health + 10;
                    const newHp = Math.min(curHp + 20, newMaxHp); // í˜„ì¬ì²´ë ¥ + 20 (ìµœëŒ€ì²´ë ¥ ì´ˆê³¼ ë¶ˆê°€)
                    // CLASSES ìŠ¤íƒ¯ ë¡œì»¬ ì—…ë°ì´íŠ¸ (ê³µê²© ê³„ì‚°ì— ì‚¬ìš©)
                    CLASSES.blacksmith.stats = {
                        moveSpeed: newMoveSpeed,
                        attack: newAttack,
                        attackSpeed: newAttackSpeed,
                        health: newMaxHp
                    };
                    playersRef.child(myPlayerId).update({
                        smithForging: false,
                        smithEnhanceLevel: smithEnhanceLevel,
                        health: newHp,
                        maxHealth: newMaxHp
                    });
                    // ê°•í™” íŒŒí‹°í´ ì´í™íŠ¸ (ë¡œì»¬ + Firebase)
                    if (players[myPlayerId]) {
                        spawnForgeEnhanceEffect(players[myPlayerId].x, players[myPlayerId].y);
                    }
                }, 2000);
            } else {
                useSkill(mouseX, mouseY);
            }
        }

        // ========== ê´€ì „ ëŒ€ìƒ ë°©í–¥ ì „í™˜ (+1: ë‹¤ìŒ, -1: ì´ì „) ==========
        function switchSpectateTarget(direction) {
            const alivePlayers = Object.keys(players).filter(id =>
                id !== myPlayerId && id !== DUMMY_ID && !players[id].isSpectator && players[id].health > 0
            );
            if (alivePlayers.length === 0) { spectateTargetId = null; return; }

            const currentIdx = alivePlayers.indexOf(spectateTargetId);
            let nextIdx = (currentIdx + direction + alivePlayers.length) % alivePlayers.length;
            spectateTargetId = alivePlayers[nextIdx];
        }

        // ========== ì¿¨íƒ€ì„ HUD ì—…ë°ì´íŠ¸ ==========
        function updateCooldownHUD() {
            const now = Date.now();

            // ëŒ€ì‰¬ ì¿¨íƒ€ì„
            const dashTotal = DASH_COOLDOWN * 1000;
            const dashRemaining = Math.max(0, dashCooldownEnd - now);
            const dashPct = dashRemaining === 0 ? 100 : Math.round((1 - dashRemaining / dashTotal) * 100);
            const dashBar = document.getElementById('dashCoolBar');
            const dashText = document.getElementById('dashCoolText');
            if (dashBar && dashText) {
                dashBar.style.width = dashPct + '%';
                dashText.textContent = dashRemaining === 0 ? 'ì¤€ë¹„' : (dashRemaining / 1000).toFixed(1) + 's';
                dashText.style.color = dashRemaining === 0 ? '#00fff5' : '#aaa';
            }

            // ìŠ¤í‚¬ ì¿¨íƒ€ì„ + ìŠ¤í‚¬ëª… ë™ì  í‘œì‹œ
            const classData = CLASSES[myClass];
            const skillName = classData ? classData.skill.name : 'ìŠ¤í‚¬';
            const skillTotal = classData ? classData.skill.cooldown * 1000 : 20000;
            const skillRemaining = Math.max(0, skillCooldownEnd - now);
            const skillPct = skillRemaining === 0 ? 100 : Math.round((1 - skillRemaining / skillTotal) * 100);
            const skillBar = document.getElementById('skillCoolBar');
            const skillText = document.getElementById('skillCoolText');
            const skillNameLabel = document.getElementById('skillNameLabel');
            const skillActionLabel = document.getElementById('skillActionLabel');
            if (skillNameLabel) skillNameLabel.textContent = skillName;
            if (skillActionLabel) skillActionLabel.textContent = skillName;
            if (skillBar && skillText) {
                skillBar.style.width = skillPct + '%';
                skillText.textContent = skillRemaining === 0 ? 'ì¤€ë¹„' : (skillRemaining / 1000).toFixed(1) + 's';
                skillText.style.color = skillRemaining === 0 ? '#00ff88' : '#aaa';
                skillBar.style.background = skillRemaining === 0 ? '#00ff88' : '#ff4444';
            }
        }

        // ========== ëŒ€ì‰¬ ì‹œìŠ¤í…œ (ëŒì§„) ==========
        function performDash() {
            if (!myPlayerId || !players[myPlayerId]) return;
            if (isDashing) return;
            const now = Date.now();
            if (now < dashCooldownEnd) return;

            const myPlayer = players[myPlayerId];
            const worldMouseX = mouseX + cameraX;
            const worldMouseY = mouseY + cameraY;
            const dx = worldMouseX - (myPlayer.x + PLAYER_SIZE / 2);
            const dy = worldMouseY - (myPlayer.y + PLAYER_SIZE / 2);
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist === 0) return;

            // ëŒ€ì‰¬ ì†ë„ = ì´ë™ì†ë„ * 5.6 (ê¸°ì¤€ moveSpeed 5 â†’ speed 28)
            // ì–´ìŒ”ì‹  ì€ì‹  ì¤‘ ëŒ€ì‰¬ ì‹œ ì€ì‹  ì´ë™ì†ë„(2ë°°) ì ìš©
            const baseSpeed = CLASSES[myClass].stats.moveSpeed;
            const effectiveSpeed = (myClass === 'assassin' && assassinStealthActive)
                ? baseSpeed * 2
                : baseSpeed;
            const DASH_SPEED = effectiveSpeed * 5.6;

            // ëŒì§„ ë°©í–¥ ì €ì¥
            dashVx = (dx / dist) * DASH_SPEED;
            dashVy = (dy / dist) * DASH_SPEED;
            dashRemainFrames = DASH_TOTAL_FRAMES;
            isDashing = true;
            dashCooldownEnd = now + DASH_COOLDOWN * 1000;
        }

        // ========== ì–´ìŒ”ì‹  ì—°ê¸° ì´í™íŠ¸ ==========
        function spawnSmokeEffect(x, y) {
            const cx = x + PLAYER_SIZE / 2;
            const cy = y + PLAYER_SIZE / 2;
            for (let i = 0; i < 20; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 2 + 0.5;
                const size = Math.random() * 10 + 5;
                assassinSmokeParticles.push({
                    x: cx + (Math.random() - 0.5) * 20,
                    y: cy + (Math.random() - 0.5) * 20,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 0.5,
                    radius: size,
                    life: 1.0,
                    decay: 0.025 + Math.random() * 0.02
                });
            }
        }

        // ========== ì–´ìŒ”ì‹  ì°Œë¥´ê¸° ì—…ë°ì´íŠ¸ ==========
        function updateAssassinStab() {
            // â”€â”€ ë‚´ ì°Œë¥´ê¸° (ì¶©ëŒ íŒì • + ì§„í–‰) â”€â”€
            if (assassinStabActive && myClass === 'assassin' && myPlayerId && players[myPlayerId]) {
                const myPlayer = players[myPlayerId];
                const cx = myPlayer.x + PLAYER_SIZE / 2;
                const cy = myPlayer.y + PLAYER_SIZE / 2;
                const progress = 1 - assassinStabFrames / ASSASSIN_STAB_TOTAL;

                // ì°Œë¥´ê¸° ëë¶€ë¶„ ìœ„ì¹˜
                const tipX = cx + Math.cos(assassinStabDir) * ASSASSIN_STAB_RANGE * Math.min(1, progress * 2);
                const tipY = cy + Math.sin(assassinStabDir) * ASSASSIN_STAB_RANGE * Math.min(1, progress * 2);

                // playerStabsì—ë„ ë‚´ í˜„ì¬ ìƒíƒœ ë°˜ì˜ (ë Œë”ë§ì— ì‚¬ìš©)
                playerStabs[myPlayerId] = {
                    ownerId: myPlayerId,
                    x: cx,
                    y: cy,
                    dir: assassinStabDir,
                    totalFrames: ASSASSIN_STAB_TOTAL,
                    frames: assassinStabFrames,
                    createdAt: playerStabs[myPlayerId]?.createdAt || Date.now()
                };

                if (!assassinStabHit) {
                    for (let id in players) {
                        if (id === myPlayerId) continue;
                        const t = players[id];
                        if (t.isSpectator || t.health <= 0) continue;
                        const tx = t.x + PLAYER_SIZE / 2;
                        const ty = t.y + PLAYER_SIZE / 2;
                        // ì°Œë¥´ê¸° ì„ ë¶„ê³¼ íƒ€ê²Ÿ ì‚¬ì´ ìµœë‹¨ê±°ë¦¬ë¡œ íˆíŠ¸íŒì • (ë„“ì´ ì¦ê°€)
                        const stabEndX = cx + Math.cos(assassinStabDir) * ASSASSIN_STAB_RANGE;
                        const stabEndY = cy + Math.sin(assassinStabDir) * ASSASSIN_STAB_RANGE;
                        const ldx = stabEndX - cx;
                        const ldy = stabEndY - cy;
                        const lenSq = ldx * ldx + ldy * ldy;
                        const t2 = Math.max(0, Math.min(1, ((tx - cx) * ldx + (ty - cy) * ldy) / lenSq));
                        const nearX = cx + t2 * ldx;
                        const nearY = cy + t2 * ldy;
                        const dist = Math.sqrt((nearX - tx) ** 2 + (nearY - ty) ** 2);
                        const HIT_WIDTH = PLAYER_SIZE / 2 + 14;
                        if (dist < HIT_WIDTH) {
                            assassinStabHit = true;
                            dealDamage(id, CLASSES.assassin.stats.attack, tx, ty);
                            break;
                        }
                    }
                }

                assassinStabFrames--;
                if (assassinStabFrames <= 0) {
                    assassinStabActive = false;
                    delete playerStabs[myPlayerId];
                    stabsRef.child(myPlayerId).remove();
                }
            }

            // â”€â”€ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ì°Œë¥´ê¸° ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ â”€â”€
            for (const id in playerStabs) {
                if (id === myPlayerId) continue;
                const stab = playerStabs[id];
                stab.frames--;
                if (stab.frames <= 0) delete playerStabs[id];
            }
        }

        // ========== ì–´ìŒ”ì‹  ì—°ê¸° íŒŒí‹°í´ ì—…ë°ì´íŠ¸ ==========
        function updateSmokeParticles() {
            for (let i = assassinSmokeParticles.length - 1; i >= 0; i--) {
                const p = assassinSmokeParticles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.95;
                p.vy *= 0.95;
                p.life -= p.decay;
                if (p.life <= 0) assassinSmokeParticles.splice(i, 1);
            }
        }

        // ëŒ€ì‰¬ íŒŒí‹°í´ ìƒì„± + Firebase ê³µìœ 
        function spawnDashParticles(x, y) {
            const now = Date.now();
            for (let i = 0; i < 5; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 2.5 + 0.5;
                const decay = 0.07 + Math.random() * 0.06;
                const p = {
                    id: myPlayerId + '_p_' + now + '_' + i,
                    ownerId: myPlayerId,
                    x: x + PLAYER_SIZE / 2,
                    y: y + PLAYER_SIZE / 2,
                    vx: Math.cos(angle) * speed - dashVx * 0.18,
                    vy: Math.sin(angle) * speed - dashVy * 0.18,
                    radius: Math.random() * 5 + 3,
                    life: 1.0,
                    decay: decay,
                    createdAt: now,  // ìˆ˜ì‹  ì¸¡ì—ì„œ ê²½ê³¼ ì‹œê°„ ë³´ì •ì— ì‚¬ìš©
                    color: players[myPlayerId] ? players[myPlayerId].color : '#fff'
                };
                particleIds.add(p.id);
                particles.push(p);
                particlesRef.child(p.id).set(p);
                setTimeout(() => particlesRef.child(p.id).remove(), 1500);
            }
        }

        // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.88;
                p.vy *= 0.88;
                p.life -= p.decay;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        // íˆíŠ¸ ì´í™íŠ¸ ìƒì„± + Firebase ê³µìœ 
        function spawnHitEffect(x, y, isFatal) {
            const now = Date.now();
            const ef = {
                id: myPlayerId + '_hit_' + now,
                ownerId: myPlayerId,
                x, y,
                isFatal,
                createdAt: now
            };
            // ë¡œì»¬ ìƒì„±
            _addHitEffect(ef);
            // Firebase ê³µìœ 
            hitEffectsRef.child(ef.id).set(ef);
            setTimeout(() => hitEffectsRef.child(ef.id).remove(), 2000); // 600â†’2000ms
        }

        function _addHitEffect(ef) {
            const count = ef.isFatal ? 18 : 10;
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * (ef.isFatal ? 6 : 4) + 1.5;
                hitEffects.push({
                    x: ef.x,
                    y: ef.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1.0,
                    decay: ef.isFatal ? 0.055 : 0.08,
                    radius: Math.random() * (ef.isFatal ? 5 : 3) + 2,
                    color: ef.isFatal ? '#ff4444' : '#ffaa00'
                });
            }
            // í™”ë©´ í”ë“¤ë¦¼ íš¨ê³¼ (ì¹˜ëª…íƒ€ë§Œ)
            if (ef.isFatal) flashScreen('#ff000033', 200);
        }

        let screenFlashColor = null;
        let screenFlashEnd = 0;
        function flashScreen(color, duration) {
            screenFlashColor = color;
            screenFlashEnd = Date.now() + duration;
        }

        function updateHitEffects() {
            for (let i = hitEffects.length - 1; i >= 0; i--) {
                const e = hitEffects[i];
                e.x += e.vx;
                e.y += e.vy;
                e.vx *= 0.85;
                e.vy *= 0.85;
                e.life -= e.decay;
                if (e.life <= 0) hitEffects.splice(i, 1);
            }
        }

        // ========== ì´ì•Œ ë°œì‚¬ (ë¡œì»¬ + Firebase ë™ê¸°í™”) ==========
        function shootBullet(targetScreenX, targetScreenY, isSkill = false) {
            if (!myPlayerId || !players[myPlayerId]) return;
            const myPlayer = players[myPlayerId];
            const classData = CLASSES[myClass];
            const startX = myPlayer.x + PLAYER_SIZE / 2;
            const startY = myPlayer.y + PLAYER_SIZE / 2;
            const targetX = targetScreenX + cameraX;
            const targetY = targetScreenY + cameraY;
            const dx = targetX - startX;
            const dy = targetY - startY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance === 0) return;

            const speed = isSkill ? classData.skill.bulletSpeed : classData.bulletSpeed;
            const dirX = dx / distance;
            const dirY = dy / distance;
            const now = Date.now();
            const bulletData = {
                id: myPlayerId + '_' + now + '_' + Math.random().toString(36).substr(2,5),
                x: startX,
                y: startY,
                vx: dirX * speed,
                vy: dirY * speed,
                damage: classData.stats.attack,
                ownerId: myPlayerId,
                createdAt: now,
                maxLifetime: isSkill ? 4500 : 4000,
                isSkillBullet: isSkill
            };
            bulletIds.add(bulletData.id);
            bullets.push(bulletData);
            // âš¡ Firebaseì— ì¦‰ì‹œ ê³µìœ  (setPriority ì œê±° â†’ ë‹¨ìˆœ setìœ¼ë¡œ ì•ˆì •ì„± í–¥ìƒ)
            bulletsRef.child(bulletData.id).set(bulletData);
            bulletsRef.child(bulletData.id).onDisconnect().remove();
        }

        // ========== ìŠ¤í‚¬ ì‚¬ìš© (ì—°ì‚¬) ==========
        function useSkill(targetScreenX, targetScreenY) {
            if (!myPlayerId || !players[myPlayerId]) return;
            
            const myPlayer = players[myPlayerId];
            const classData = CLASSES[myClass];
            
            // ë°©í–¥ ê³„ì‚° (ì›”ë“œ ì¢Œí‘œ)
            const startX = myPlayer.x + PLAYER_SIZE / 2;
            const startY = myPlayer.y + PLAYER_SIZE / 2;
            const targetX = targetScreenX + cameraX;
            const targetY = targetScreenY + cameraY;
            
            const dx = targetX - startX;
            const dy = targetY - startY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > 0) {
                // ìŠ¤í‚¬ ë°©í–¥ ì €ì¥ (ê³ ì •)
                skillDirection.x = dx / distance;
                skillDirection.y = dy / distance;
                
                // ìŠ¤í‚¬ ìƒíƒœ ì„¤ì •
                isUsingSkill = true;
                skillBulletCount = 0;
                lastSkillBullet = Date.now();
                
                console.log('ì—°ì‚¬ ìŠ¤í‚¬ ì‚¬ìš©!');
            }
        }

        // ========== ìŠ¤í‚¬ ì—…ë°ì´íŠ¸ (ì—°ì‚¬ ë°œì‚¬) ==========
        function updateSkill() {
            if (!isUsingSkill) return;
            if (!myPlayerId || !players[myPlayerId]) return;
            const now = Date.now();
            const classData = CLASSES[myClass];
            const myPlayer = players[myPlayerId];

            if (now - lastSkillBullet >= classData.skill.bulletInterval) {
                const startX = myPlayer.x + PLAYER_SIZE / 2;
                const startY = myPlayer.y + PLAYER_SIZE / 2;
                const bulletData = {
                    id: myPlayerId + '_skill_' + now + '_' + skillBulletCount,
                    x: startX,
                    y: startY,
                    vx: skillDirection.x * classData.skill.bulletSpeed,
                    vy: skillDirection.y * classData.skill.bulletSpeed,
                    damage: classData.stats.attack,
                    ownerId: myPlayerId,
                    createdAt: now,
                    maxLifetime: 3000,
                    isSkillBullet: true
                };
                bulletIds.add(bulletData.id);
                bullets.push(bulletData);
                bulletsRef.child(bulletData.id).set(bulletData);
                bulletsRef.child(bulletData.id).onDisconnect().remove();

                skillBulletCount++;
                lastSkillBullet = now;

                if (skillBulletCount >= classData.skill.bullets) {
                    isUsingSkill = false;
                    skillCooldownEnd = now + classData.skill.cooldown * 1000;
                }
            }
        }

        // ========== ì›Œë¦¬ì–´ ê²€ íœ˜ë‘ë¥´ê¸° ì—…ë°ì´íŠ¸ ==========
        function updateWarriorSwing() {
            // â”€â”€ ë‚´ ìŠ¤ìœ™ (ì¶©ëŒ íŒì • + ì§„í–‰) â”€â”€
            if (warriorSwingActive && myClass === 'warrior' && myPlayerId && players[myPlayerId]) {
                const myPlayer = players[myPlayerId];
                const cx = myPlayer.x + PLAYER_SIZE / 2;
                const cy = myPlayer.y + PLAYER_SIZE / 2;
                const progress = 1 - warriorSwingFrames / WARRIOR_SWING_TOTAL;
                const halfArc = _currentSwingArc / 2;
                warriorSwingAngle = warriorSwingDir - halfArc + _currentSwingArc * progress;

                // playerSwingsì—ë„ ë‚´ í˜„ì¬ ìƒíƒœ ë°˜ì˜ (ë Œë”ë§ì— ì‚¬ìš©)
                playerSwings[myPlayerId] = {
                    ownerId: myPlayerId,
                    dir: warriorSwingDir,
                    arc: _currentSwingArc,
                    range: _currentSwingRange,
                    totalFrames: WARRIOR_SWING_TOTAL,
                    frames: warriorSwingFrames,
                    angle: warriorSwingAngle,
                    createdAt: playerSwings[myPlayerId]?.createdAt || Date.now()
                };

                const isSpinAttack = (_currentSwingArc >= Math.PI * 1.9);

                for (let id in players) {
                    if (id === myPlayerId || swingHitIds.has(id)) continue;
                    const t = players[id];
                    if (t.isSpectator || t.health <= 0) continue;

                    const tx = t.x + PLAYER_SIZE / 2;
                    const ty = t.y + PLAYER_SIZE / 2;
                    const dx = tx - cx;
                    const dy = ty - cy;
                    const distToTarget = Math.sqrt(dx * dx + dy * dy);

                    // ê±°ë¦¬ ì²´í¬: ê²€ ë²”ìœ„ + í”Œë ˆì´ì–´ ë°˜ê²½
                    if (distToTarget > _currentSwingRange + PLAYER_SIZE / 2) continue;

                    if (isSpinAttack) {
                        // â”€â”€ 360ë„ íšŒì „: ë²”ìœ„ ì•ˆì´ë©´ ë¬´ì¡°ê±´ íˆíŠ¸ (ê°ë„ ë¬´ê´€) â”€â”€
                        swingHitIds.add(id);
                        dealDamage(id, CLASSES.warrior.stats.attack, tx, ty);
                    } else {
                        // â”€â”€ ì¼ë°˜ ìŠ¤ìœ™: í˜„ì¬ê¹Œì§€ íœ˜ë‘ë¥¸ í˜¸(arc) ì•ˆì— ìˆìœ¼ë©´ íˆíŠ¸ â”€â”€
                        const swingStartAngle = warriorSwingDir - halfArc;
                        const swungArc = _currentSwingArc * progress;
                        const angleToTarget = Math.atan2(dy, dx);

                        // ê°ë„ ì°¨ì´ë¥¼ [0, swungArc] ë²”ìœ„ë¡œ ì •ê·œí™”
                        let relAngle = angleToTarget - swingStartAngle;
                        relAngle = relAngle - Math.floor(relAngle / (Math.PI * 2)) * Math.PI * 2;

                        if (relAngle <= swungArc) {
                            swingHitIds.add(id);
                            dealDamage(id, CLASSES.warrior.stats.attack, tx, ty);
                        }
                    }
                }

                warriorSwingFrames--;
                if (warriorSwingFrames <= 0) {
                    warriorSwingActive = false;
                    swingHitIds.clear();
                    delete playerSwings[myPlayerId];
                    swingsRef.child(myPlayerId).remove();
                }
            }

            // â”€â”€ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ìŠ¤ìœ™ ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ â”€â”€
            for (const id in playerSwings) {
                if (id === myPlayerId) continue;
                const sw = playerSwings[id];
                const progress = 1 - sw.frames / sw.totalFrames;
                sw.angle = sw.dir - sw.arc / 2 + sw.arc * progress;
                sw.frames--;
                if (sw.frames <= 0) delete playerSwings[id];
            }
        }

        // ========== ëŒ€ì¥ì¥ì´ ë§ì¹˜ ê³µê²© ì—…ë°ì´íŠ¸ ==========
        function updateSmithHammer() {
            // â”€â”€ ë‚´ ë§ì¹˜ ê³µê²© (ì¶©ëŒ íŒì • + ì§„í–‰) â”€â”€
            if (smithHammerActive && myClass === 'blacksmith' && myPlayerId && players[myPlayerId]) {
                const myPlayer = players[myPlayerId];
                const cx = myPlayer.x + PLAYER_SIZE / 2;
                const cy = myPlayer.y + PLAYER_SIZE / 2;
                const progress = 1 - smithHammerFrames / SMITH_HAMMER_TOTAL;

                // playerHammersì—ë„ ë‚´ í˜„ì¬ ìƒíƒœ ë°˜ì˜ (ë Œë”ë§ì— ì‚¬ìš©)
                playerHammers[myPlayerId] = {
                    ownerId: myPlayerId,
                    x: cx,
                    y: cy,
                    dir: smithHammerDir,
                    totalFrames: SMITH_HAMMER_TOTAL,
                    frames: smithHammerFrames,
                    enhanceLevel: smithEnhanceLevel,
                    createdAt: playerHammers[myPlayerId]?.createdAt || Date.now()
                };

                // íŒì •ì€ ì˜ˆê³  êµ¬ê°„(SMITH_HAMMER_HIT_FRAME) ì´í›„ë¶€í„°ë§Œ í™œì„±í™”
                const elapsed = SMITH_HAMMER_TOTAL - smithHammerFrames;
                if (elapsed >= SMITH_HAMMER_HIT_FRAME && !smithHammerHit) {                    const frontDist = SMITH_HAMMER_HEIGHT;
                    const cosD = Math.cos(smithHammerDir);
                    const sinD = Math.sin(smithHammerDir);
                    // ì§ê° ë²¡í„°
                    const perpX = -sinD;
                    const perpY = cosD;

                    for (let id in players) {
                        if (id === myPlayerId || smithHammerHitIds.has(id)) continue;
                        const t = players[id];
                        if (t.isSpectator || t.health <= 0) continue;
                        const tx = t.x + PLAYER_SIZE / 2;
                        const ty = t.y + PLAYER_SIZE / 2;
                        const dx = tx - cx;
                        const dy = ty - cy;
                        // ë¡œì»¬ ì¢Œí‘œë¡œ ë³€í™˜ (ì •ë°©í–¥, ì§ê°)
                        const forward = dx * cosD + dy * sinD;
                        const lateral = dx * perpX + dy * perpY;
                        // ì‚¬ê°í˜• ë²”ìœ„ ì•ˆì´ë©´ íˆíŠ¸ (ìºë¦­í„° ë°”ë¡œ ì• ì •ì‚¬ê°í˜•)
                        const offsetFront = PLAYER_SIZE / 2 + 4;
                        if (forward >= offsetFront && forward <= offsetFront + SMITH_HAMMER_RANGE * 2 + PLAYER_SIZE / 2
                            && Math.abs(lateral) <= SMITH_HAMMER_RANGE + PLAYER_SIZE / 2) {
                            smithHammerHitIds.add(id);
                            dealDamage(id, CLASSES.blacksmith.stats.attack, tx, ty);
                        }
                    }
                    if (smithHammerHitIds.size > 0) smithHammerHit = true;
                }

                smithHammerFrames--;
                if (smithHammerFrames <= 0) {
                    smithHammerActive = false;
                    smithHammerHitIds.clear();
                    delete playerHammers[myPlayerId];
                    smithHammersRef.child(myPlayerId).remove();
                }
            }

            // â”€â”€ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ë§ì¹˜ ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ â”€â”€
            for (const id in playerHammers) {
                if (id === myPlayerId) continue;
                const h = playerHammers[id];
                h.frames--;
                if (h.frames <= 0) delete playerHammers[id];
            }
        }

        // ========== ì‚¬ë¬´ë¼ì´ ë°˜ê²© ëŒì§„ ì‹œì‘ ==========
        function _startSamuraiCounter() {
            samuraiCounterActive = true;
            samuraiCounterFrames = SAMURAI_COUNTER_FRAMES;
            samuraiCounterHitIds.clear();
            // â˜… ë°˜ê²© ë°œë™ ìˆœê°„ì˜ ë§ˆìš°ìŠ¤ ë°©í–¥ìœ¼ë¡œ ì¬ê³„ì‚°
            if (myPlayerId && players[myPlayerId]) {
                const mp = players[myPlayerId];
                const wdx = (mouseX + cameraX) - (mp.x + PLAYER_SIZE / 2);
                const wdy = (mouseY + cameraY) - (mp.y + PLAYER_SIZE / 2);
                samuraiParryDir = Math.atan2(wdy, wdx);
            }
            samuraiCounterVx = Math.cos(samuraiParryDir) * SAMURAI_COUNTER_SPEED;
            samuraiCounterVy = Math.sin(samuraiParryDir) * SAMURAI_COUNTER_SPEED;
            // Firebase ê³µìœ : ë°˜ê²© ìŠ¬ë˜ì‹œë¡œ í‘œì‹œ
            const now = Date.now();
            samuraiSlashesRef.child('counter_' + myPlayerId).set({
                ownerId: myPlayerId, type: 'counter',
                dir: samuraiParryDir, totalFrames: SAMURAI_COUNTER_FRAMES, createdAt: now
            });
            playerSamuraiSlashes['counter_' + myPlayerId] = {
                ownerId: myPlayerId, type: 'counter',
                dir: samuraiParryDir, totalFrames: SAMURAI_COUNTER_FRAMES,
                frames: SAMURAI_COUNTER_FRAMES, angle: samuraiParryDir, createdAt: now
            };
        }

        // ========== ì‚¬ë¬´ë¼ì´ ì—…ë°ì´íŠ¸ ==========
        function updateSamurai() {
            if (!myPlayerId || !players[myPlayerId] || myClass !== 'samurai') {
                // ë‹¤ë¥¸ í”Œë ˆì´ì–´ ì‚¬ë¬´ë¼ì´ ìŠ¬ë˜ì‹œ ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰
                for (const key in playerSamuraiSlashes) {
                    const s = playerSamuraiSlashes[key];
                    if (s.ownerId === myPlayerId) continue;
                    s.progress = 1 - s.frames / s.totalFrames;
                    s.frames--;
                    if (s.frames <= 0) delete playerSamuraiSlashes[key];
                }
                return;
            }

            const myPlayer = players[myPlayerId];
            const cx = myPlayer.x + PLAYER_SIZE / 2;
            const cy = myPlayer.y + PLAYER_SIZE / 2;

            // â”€â”€ ë°˜ê²© ëŒì§„ â”€â”€
            if (samuraiCounterActive && samuraiCounterFrames > 0) {
                myPlayer.x = Math.max(0, Math.min(2000 - PLAYER_SIZE, myPlayer.x + samuraiCounterVx));
                myPlayer.y = Math.max(0, Math.min(2000 - PLAYER_SIZE, myPlayer.y + samuraiCounterVy));
                playersRef.child(myPlayerId).update({ x: myPlayer.x, y: myPlayer.y });

                // ê²½ë¡œìƒ ì  í”¼í•´
                for (let id in players) {
                    if (id === myPlayerId || samuraiCounterHitIds.has(id)) continue;
                    const t = players[id];
                    if (t.isSpectator || t.health <= 0) continue;
                    const tx = t.x + PLAYER_SIZE / 2;
                    const ty = t.y + PLAYER_SIZE / 2;
                    const dist = Math.sqrt((myPlayer.x + PLAYER_SIZE/2 - tx)**2 + (myPlayer.y + PLAYER_SIZE/2 - ty)**2);
                    if (dist < PLAYER_SIZE + 10) {
                        samuraiCounterHitIds.add(id);
                        dealDamage(id, SAMURAI_COUNTER_DMG, tx, ty);
                    }
                }

                samuraiCounterFrames--;
                if (samuraiCounterFrames <= 0) {
                    samuraiCounterActive = false;
                    samuraiCounterHitIds.clear();
                    samuraiSlashesRef.child('counter_' + myPlayerId).remove();
                    delete playerSamuraiSlashes['counter_' + myPlayerId];
                }
            }

            // â”€â”€ ì°Œë¥´ê¸° â”€â”€
            if (samuraiSlashActive) {
                samuraiSlashProgress = 1 - samuraiSlashFrames / SAMURAI_SLASH_TOTAL;

                // ëŒì§„
                if (samuraiSlashDashFrames > 0) {
                    myPlayer.x = Math.max(0, Math.min(2000 - PLAYER_SIZE, myPlayer.x + samuraiSlashDashVx));
                    myPlayer.y = Math.max(0, Math.min(2000 - PLAYER_SIZE, myPlayer.y + samuraiSlashDashVy));
                    playersRef.child(myPlayerId).update({ x: myPlayer.x, y: myPlayer.y });
                    samuraiSlashDashFrames--;
                }

                // ë Œë”ë§ìš© ë‚´ ìŠ¬ë˜ì‹œ ìƒíƒœ ê°±ì‹ 
                const _lvl = samuraiCurrentLevel || SAMURAI_CHARGE_LEVELS[3];
                playerSamuraiSlashes[myPlayerId] = {
                    ownerId: myPlayerId, type: 'slash',
                    dir: samuraiSlashDir, totalFrames: SAMURAI_SLASH_TOTAL,
                    frames: samuraiSlashFrames, progress: samuraiSlashProgress,
                    thrustLength: _lvl.length, thrustWidth: _lvl.width,
                    createdAt: playerSamuraiSlashes[myPlayerId]?.createdAt || Date.now()
                };

                // íˆíŠ¸ íŒì • (ì§ì‚¬ê°í˜• ì°Œë¥´ê¸°) - progress > 0.25ë¶€í„°
                if (samuraiSlashProgress > 0.25) {
                    const lvl = samuraiCurrentLevel || SAMURAI_CHARGE_LEVELS[3];
                    const thrustLength = lvl.length * samuraiSlashProgress;
                    const halfW = lvl.width / 2 + PLAYER_SIZE / 2;
                    const dirX = Math.cos(samuraiSlashDir);
                    const dirY = Math.sin(samuraiSlashDir);

                    for (let id in players) {
                        if (id === myPlayerId || samuraiSlashHitIds.has(id)) continue;
                        const t = players[id];
                        if (t.isSpectator || t.health <= 0) continue;
                        const tx = t.x + PLAYER_SIZE / 2;
                        const ty = t.y + PLAYER_SIZE / 2;

                        const relX = tx - (myPlayer.x + PLAYER_SIZE / 2);
                        const relY = ty - (myPlayer.y + PLAYER_SIZE / 2);
                        const parallelDist = relX * dirX + relY * dirY;
                        const perpDist = Math.abs(-relY * dirX + relX * dirY);

                        // ì‹œì‘ì ì„ -PLAYER_SIZEê¹Œì§€ í™•ì¥í•´ ëŒì§„ í›„ ë°”ë¡œ ë¶™ì€ ì ë„ íŒì •
                        if (parallelDist >= -PLAYER_SIZE && parallelDist <= thrustLength && perpDist < halfW) {
                            samuraiSlashHitIds.add(id);
                            dealDamage(id, lvl.dmg, tx, ty);
                        }
                    }
                }

                samuraiSlashFrames--;
                if (samuraiSlashFrames <= 0) {
                    samuraiSlashActive = false;
                    samuraiSlashHitIds.clear();
                    delete playerSamuraiSlashes[myPlayerId];
                    samuraiSlashesRef.child(myPlayerId).remove();
                }
            }

            // â”€â”€ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ìŠ¬ë˜ì‹œ ì• ë‹ˆë©”ì´ì…˜ â”€â”€
            for (const key in playerSamuraiSlashes) {
                const s = playerSamuraiSlashes[key];
                if (s.ownerId === myPlayerId) continue;
                if (s.type === 'counter') {
                    s.frames--;
                    if (s.frames <= 0) delete playerSamuraiSlashes[key];
                } else {
                    s.progress = 1 - s.frames / s.totalFrames;
                    s.frames--;
                    if (s.frames <= 0) delete playerSamuraiSlashes[key];
                }
            }
        }

        // ========== ì¤‘ì•™ í”¼í•´ ì²˜ë¦¬ í•¨ìˆ˜ ==========
        // ëª¨ë“  ê³µê²©ì€ ë°˜ë“œì‹œ ì´ í•¨ìˆ˜ë¥¼ í†µí•´ í”¼í•´ë¥¼ ì¤Œ.
        // íŒ¨ë§ì€ ì—¬ê¸°ì„œ HPë¥¼ ê±´ë“œë¦¬ê¸° ì „ì— ë¨¼ì € ì°¨ë‹¨ â†’ ë”¸í”¼ì—¬ë„ ì•ˆì „.
        // í–¥í›„ ì§ì—… ì¶”ê°€ ì‹œ dealDamageë§Œ ì“°ë©´ ìë™ìœ¼ë¡œ íŒ¨ë§ ì ìš©ë¨.
        function dealDamage(targetId, dmg, hitX, hitY) {
            const target = players[targetId];
            if (!target || target.isSpectator || target.health <= 0) return;

            // â”€â”€ ì‚¬ë¬´ë¼ì´ íŒ¨ë§: HP ê±´ë“œë¦¬ê¸° ì „ì— ë¨¼ì € ì°¨ë‹¨ â”€â”€
            // target.samuraiParryingì€ Firebase players í•„ë“œ â†’ í•­ìƒ ìµœì‹  ìƒíƒœ
            if (target.samuraiParrying) {
                // ê³µê²©ì í´ë¼ì´ì–¸íŠ¸ì—ì„œ HPë¥¼ ê±´ë“œë¦¬ì§€ ì•Šê³  íŠ•ê²¨ëƒ„
                spawnHitEffect(hitX, hitY, false);
                // í”¼ê²©ìì—ê²Œ íŒ¨ë§ íˆíŠ¸ ì‹ í˜¸ ì „ì†¡ (í”¼ê²©ì í´ë¼ì´ì–¸íŠ¸ê°€ ë°˜ê²© íŠ¸ë¦¬ê±°)
                parryHitsRef.child(targetId).set({ targetId, createdAt: Date.now() });
                setTimeout(() => parryHitsRef.child(targetId).remove(), 1000);
                return;
            }

            const newHp = Math.max(0, target.health - dmg);
            const isFatal = newHp <= 0;
            playersRef.child(targetId).update({ health: newHp });
            if (isFatal) playersRef.child(targetId).update({ isSpectator: true });
            spawnHitEffect(hitX, hitY, isFatal);
        }

        // â”€â”€ íŒ¨ë§ ë°˜ê²© íŠ¸ë¦¬ê±° â”€â”€
        // í”¼ê²©ì ë³¸ì¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ hitEffectsRefë¥¼ í†µí•´ íŒ¨ë§ íˆíŠ¸ ì‹ í˜¸ë¥¼ ë°›ì•„ ë°˜ê²©.
        // dealDamageê°€ HPë¥¼ ê±´ë“œë¦¬ì§€ ì•Šìœ¼ë¯€ë¡œ HP ë¦¬ìŠ¤ë„ˆë¡œëŠ” ê°ì§€ ë¶ˆê°€.
        // ëŒ€ì‹  ê³µê²©ìê°€ dealDamageì—ì„œ íŒ¨ë§ì„ ê°ì§€í•˜ë©´ parryHitRefì— ì‹ í˜¸ë¥¼ ìœë‹¤.
        function _checkAndTriggerParry() {
            if (myClass !== 'samurai' || !samuraiParryActive || samuraiParryHit) return;
            samuraiParryHit = true;
            samuraiParryActive = false;
            playersRef.child(myPlayerId).update({ samuraiParrying: false });
            samuraiSlashesRef.child('parry_' + myPlayerId).remove();
            _startSamuraiCounter();
        }
        function spawnForgeEnhanceEffect(x, y) {
            const now = Date.now();
            const cx = x + PLAYER_SIZE / 2;
            const cy = y + PLAYER_SIZE / 2;
            // í™©ê¸ˆ íŒŒí‹°í´ ë¶„ì¶œ
            for (let i = 0; i < 25; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 1.5;
                const p = {
                    id: myPlayerId + '_forge_' + now + '_' + i,
                    ownerId: myPlayerId,
                    x: cx + (Math.random() - 0.5) * 20,
                    y: cy + (Math.random() - 0.5) * 20,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 1.5,
                    radius: Math.random() * 6 + 3,
                    life: 1.0,
                    decay: 0.03 + Math.random() * 0.03,
                    createdAt: now,
                    color: i % 2 === 0 ? '#ffd700' : '#ff8c00'
                };
                particleIds.add(p.id);
                particles.push(p);
                particlesRef.child(p.id).set(p);
                setTimeout(() => particlesRef.child(p.id).remove(), 2500);
            }
        }

        // ========== ì´ì•Œ ì—…ë°ì´íŠ¸ ==========
        function updateBullets() {
            const now = Date.now();
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;

                // ìˆ˜ëª… ì´ˆê³¼
                if (now - bullet.createdAt > bullet.maxLifetime) {
                    if (bullet.ownerId === myPlayerId) bulletsRef.child(bullet.id).remove();
                    bulletIds.delete(bullet.id);
                    bullets.splice(i, 1);
                    continue;
                }
                // ë§µ ë°–
                if (bullet.x < -100 || bullet.x > 2100 || bullet.y < -100 || bullet.y > 2100) {
                    if (bullet.ownerId === myPlayerId) bulletsRef.child(bullet.id).remove();
                    bulletIds.delete(bullet.id);
                    bullets.splice(i, 1);
                    continue;
                }

                // ===== ì¶©ëŒ ê°ì§€ (ì´ì•Œ ë°œì‚¬ìë§Œ ì²˜ë¦¬) =====
                if (bullet.ownerId !== myPlayerId) continue;
                for (let id in players) {
                    if (id === bullet.ownerId) continue;
                    const target = players[id];
                    if (target.isSpectator || target.health <= 0) continue;
                    const tx = target.x + PLAYER_SIZE / 2;
                    const ty = target.y + PLAYER_SIZE / 2;
                    const dist = Math.sqrt((bullet.x - tx) ** 2 + (bullet.y - ty) ** 2);
                    if (dist < PLAYER_SIZE / 2 + (bullet.isSkillBullet ? 6 : 4)) {
                        // ì›Œë¦¬ì–´ ìŠ¤í‚¬ ì¤‘ì´ë©´ í”¼í•´ 50% ê°ì†Œ
                        let dmg = bullet.damage;
                        if (target.warriorSkillActive) dmg = Math.ceil(dmg * 0.5);
                        dealDamage(id, dmg, bullet.x, bullet.y);

                        bulletsRef.child(bullet.id).remove();
                        bulletIds.delete(bullet.id);
                        bullets.splice(i, 1);
                        break;
                    }
                }
            }
        }

        // ========== ê´€ì „ ëŒ€ìƒ ì„ íƒ ==========
        function pickRandomSpectateTarget() {
            const alivePlayers = Object.keys(players).filter(id =>
                id !== myPlayerId && id !== DUMMY_ID && !players[id].isSpectator && players[id].health > 0
            );
            if (alivePlayers.length === 0) {
                spectateTargetId = null;
                return;
            }
            const randomIdx = Math.floor(Math.random() * alivePlayers.length);
            spectateTargetId = alivePlayers[randomIdx];
        }

        // ========== ê²Œì„ ê°•ì œ ì¢…ë£Œ (ëˆ„êµ¬ë‚˜) ==========
        function stopGame() {
            if (isHost && currentRoomId) {
                database.ref('rooms/' + currentRoomId).remove();
            } else {
                gameStateRef.update({ status: GAME_STATUS.LOBBY });
                playersRef.remove();
            }
            location.reload();
        }

        // ========== ê²Œì„ ë£¨í”„ ==========
        function gameLoop() {
            if (gameStatus !== GAME_STATUS.PLAYING) return;
            
            update();
            render();
            
            requestAnimationFrame(gameLoop);
        }

        function update() {
            // Rí‚¤ í™€ë“œ â†’ ê°•ì œ ì¢…ë£Œ ì²´í¬ (ëˆ„êµ¬ë‚˜)
            if (rKeyHolding && gameStatus === GAME_STATUS.PLAYING) {
                const held = Date.now() - rKeyPressStart;
                forceStopProgress = Math.min(100, (held / 3000) * 100);
                if (held >= 3000) {
                    rKeyHolding = false;
                    stopGame();
                    return;
                }
            }

            // ê´€ì „ ëª¨ë“œ ì¹´ë©”ë¼
            if (isSpectating || !isAlive) {
                if (spectateTargetId && players[spectateTargetId]) {
                    const target = players[spectateTargetId];
                    cameraX = target.x - canvas.width / 2 + PLAYER_SIZE / 2;
                    cameraY = target.y - canvas.height / 2 + PLAYER_SIZE / 2;
                }
                updateBullets();
                updateParticles();
                updateHitEffects();
                updateWarriorSwing();  // ì›Œë¦¬ì–´ ìŠ¤ìœ™ë„ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ í”Œë ˆì´ì–´ ì• ë‹ˆë©”ì´ì…˜)
                updateAssassinStab();  // ì–´ìŒ”ì‹  ì°Œë¥´ê¸° ì• ë‹ˆë©”ì´ì…˜
                updateSmokeParticles(); // ì—°ê¸° íŒŒí‹°í´
                updateSmithHammer();   // ëŒ€ì¥ì¥ì´ ë§ì¹˜ ê³µê²© ì• ë‹ˆë©”ì´ì…˜
                updateSamurai();       // ì‚¬ë¬´ë¼ì´ ë² ê¸°/íŒ¨ë§/ë°˜ê²© ì• ë‹ˆë©”ì´ì…˜
                updateCooldownHUD();
                document.getElementById('spectateHint').style.display = 'block';
                return;
            }

            if (!myPlayerId || !players[myPlayerId]) return;
            
            const myPlayer = players[myPlayerId];
            const stats = CLASSES[myClass].stats;
            let moved = false;

            // ì´ë™ì†ë„ (ì›Œë¦¬ì–´ ìŠ¤í‚¬ ì‹œ 25% ì¦ê°€, ì–´ìŒ”ì‹  ì€ì‹  ì‹œ 2ë°°, ëŒ€ì¥ì¥ì´ ê²½ì§ ì‹œ 0)
            const curSpeed = (smithForging || samuraiParryActive)
                ? 0
                : (myClass === 'warrior' && warriorSkillActive)
                ? stats.moveSpeed * 1.25
                : (myClass === 'assassin' && assassinStealthActive)
                ? stats.moveSpeed * 2
                : stats.moveSpeed;

            // ëŒì§„ ì²˜ë¦¬
            if (samuraiCounterActive) {
                // ì‚¬ë¬´ë¼ì´ ë°˜ê²© ëŒì§„ ì¤‘ â€” updateSamuraiì—ì„œ ì²˜ë¦¬
                moved = true;
            } else if (isDashing && dashRemainFrames > 0) {
                spawnDashParticles(myPlayer.x, myPlayer.y);
                myPlayer.x += dashVx;
                myPlayer.y += dashVy;
                myPlayer.x = Math.max(0, Math.min(2000 - PLAYER_SIZE, myPlayer.x));
                myPlayer.y = Math.max(0, Math.min(2000 - PLAYER_SIZE, myPlayer.y));
                dashRemainFrames--;
                moved = true;
                if (dashRemainFrames <= 0) isDashing = false;
            } else {
                if (keys['w'] || keys['ã…ˆ']) { myPlayer.y -= curSpeed; moved = true; }
                if (keys['s'] || keys['ã„´']) { myPlayer.y += curSpeed; moved = true; }
                if (keys['a'] || keys['ã…']) { myPlayer.x -= curSpeed; moved = true; }
                if (keys['d'] || keys['ã„¹']) { myPlayer.x += curSpeed; moved = true; }
                myPlayer.x = Math.max(0, Math.min(2000 - PLAYER_SIZE, myPlayer.x));
                myPlayer.y = Math.max(0, Math.min(2000 - PLAYER_SIZE, myPlayer.y));
            }
            
            // ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸
            cameraX = myPlayer.x - canvas.width / 2 + PLAYER_SIZE / 2;
            cameraY = myPlayer.y - canvas.height / 2 + PLAYER_SIZE / 2;
            
            if (moved) {
                playersRef.child(myPlayerId).update({
                    x: myPlayer.x,
                    y: myPlayer.y,
                    timestamp: Date.now()
                });
            }
            
            document.getElementById('myHealth').textContent = `${myPlayer.health}/${myPlayer.maxHealth}`;
            
            // ì–´ìŒ”ì‹  ì€ì‹  ë§Œë£Œ ì²´í¬
            if (myClass === 'assassin' && assassinStealthActive && Date.now() > assassinStealthEnd) {
                assassinStealthActive = false;
                playersRef.child(myPlayerId).update({ stealthed: false });
            }

            updateSkill();
            updateWarriorSwing();
            updateAssassinStab();
            updateSmokeParticles();
            updateSmithHammer();
            updateSamurai();
            updateBullets();
            updateParticles();
            updateHitEffects();
            updateCooldownHUD();
        }

        function render() {
            // ë°°ê²½
            ctx.fillStyle = '#0f3460';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ë§µ ì¢Œí‘œ
            const mapScreenX = -cameraX;
            const mapScreenY = -cameraY;

            // ê·¸ë¦¬ë“œ (ì¹´ë©”ë¼ ì˜¤í”„ì…‹ ì ìš©)
            ctx.strokeStyle = 'rgba(0, 255, 245, 0.1)';
            ctx.lineWidth = 1;
            const gridSize = 50;
            const startX = Math.floor(cameraX / gridSize) * gridSize;
            const startY = Math.floor(cameraY / gridSize) * gridSize;
            for (let x = startX; x < cameraX + canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x - cameraX, 0);
                ctx.lineTo(x - cameraX, canvas.height);
                ctx.stroke();
            }
            for (let y = startY; y < cameraY + canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y - cameraY);
                ctx.lineTo(canvas.width, y - cameraY);
                ctx.stroke();
            }

            // ë§µ ê²½ê³„ì„ 
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 100, 100, 0.7)';
            ctx.lineWidth = 3;
            ctx.strokeRect(mapScreenX, mapScreenY, MAP_W, MAP_H);
            // ë§µ ë°– ì˜¤ë²„ë ˆì´
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            if (mapScreenY > 0) ctx.fillRect(0, 0, canvas.width, mapScreenY);
            if (mapScreenY + MAP_H < canvas.height) ctx.fillRect(0, mapScreenY + MAP_H, canvas.width, canvas.height - mapScreenY - MAP_H);
            if (mapScreenX > 0) ctx.fillRect(0, mapScreenY, mapScreenX, MAP_H);
            if (mapScreenX + MAP_W < canvas.width) ctx.fillRect(mapScreenX + MAP_W, mapScreenY, canvas.width - mapScreenX - MAP_W, MAP_H);
            ctx.restore();
            
            // ëª¨ë“  í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
            for (let id in players) {
                const player = players[id];
                const isMe = id === myPlayerId;

                // ê´€ì „ìëŠ” ê·¸ë¦¬ì§€ ì•ŠìŒ
                if (player.isSpectator) continue;
                // ì‚¬ë§í•œ í”Œë ˆì´ì–´ë„ ê·¸ë¦¬ì§€ ì•ŠìŒ
                if (player.health <= 0) continue;
                // ì–´ìŒ”ì‹  ì€ì‹ : ë‚´ê°€ ì•„ë‹Œ í”Œë ˆì´ì–´ì—ê²Œ ë³´ì´ì§€ ì•ŠìŒ
                if (!isMe && player.stealthed) continue;
                
                const screenX = player.x - cameraX;
                const screenY = player.y - cameraY;
                
                if (screenX < -PLAYER_SIZE || screenX > canvas.width || 
                    screenY < -PLAYER_SIZE || screenY > canvas.height) {
                    continue;
                }
                
                // ê´€ì „ ëŒ€ìƒ ê°•ì¡° (ë…¸ë€ ì›)
                if (id === spectateTargetId) {
                    ctx.strokeStyle = 'rgba(255, 215, 0, 0.6)';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.arc(screenX + PLAYER_SIZE / 2, screenY + PLAYER_SIZE / 2, PLAYER_SIZE / 2 + 8, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // ì–´ìŒ”ì‹  ì€ì‹  ì‹œ ë°˜íˆ¬ëª… ì²˜ë¦¬ (ìì‹ ì—ê²Œë§Œ)
                const stealthAlpha = (isMe && player.stealthed) ? 0.35 : 1.0;
                ctx.save();
                ctx.globalAlpha = stealthAlpha;

                // ì²´ë ¥ë°” (ê°œì„ )
                const hpBarW = PLAYER_SIZE + 20;
                const hpBarH = 8;
                const hpBarX = screenX + PLAYER_SIZE / 2 - hpBarW / 2;
                const hpBarY = screenY - 22;
                const healthPercent = Math.max(0, player.health / player.maxHealth);

                // ê·¸ë¦¼ì
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(hpBarX - 1, hpBarY - 1, hpBarW + 2, hpBarH + 2);
                // ë°°ê²½
                ctx.fillStyle = '#1a0000';
                ctx.fillRect(hpBarX, hpBarY, hpBarW, hpBarH);
                // ì²´ë ¥ ìƒ‰ìƒ ê·¸ë¼ë°ì´ì…˜
                const hpGrad = ctx.createLinearGradient(hpBarX, hpBarY, hpBarX + hpBarW * healthPercent, hpBarY);
                if (healthPercent > 0.5) {
                    hpGrad.addColorStop(0, '#00e676');
                    hpGrad.addColorStop(1, '#69f0ae');
                } else if (healthPercent > 0.25) {
                    hpGrad.addColorStop(0, '#ff9800');
                    hpGrad.addColorStop(1, '#ffcc02');
                } else {
                    hpGrad.addColorStop(0, '#e53935');
                    hpGrad.addColorStop(1, '#ff5252');
                }
                ctx.fillStyle = hpGrad;
                ctx.fillRect(hpBarX, hpBarY, hpBarW * healthPercent, hpBarH);
                // í…Œë‘ë¦¬
                ctx.strokeStyle = 'rgba(255,255,255,0.4)';
                ctx.lineWidth = 1;
                ctx.strokeRect(hpBarX, hpBarY, hpBarW, hpBarH);

                // â”€â”€ ì‚¬ë¬´ë¼ì´ ì°¨ì§• ê²Œì´ì§€ (ì²´ë ¥ë°” ë°”ë¡œ ìœ„, ë‹‰ë„¤ì„ ì•„ë˜) â”€â”€
                if (player.class === 'samurai' && player.samuraiCharging && player.samuraiChargeStart) {
                    const now2 = Date.now();
                    const chargedMs2 = Math.min(now2 - player.samuraiChargeStart, SAMURAI_MAX_CHARGE);
                    const chargeRatio2 = chargedMs2 / SAMURAI_MAX_CHARGE;
                    const cgW = hpBarW;
                    const cgH = 4;
                    const cgX = hpBarX;
                    const cgY = hpBarY - cgH - 3;
                    // ë°°ê²½
                    ctx.fillStyle = 'rgba(0,0,0,0.5)';
                    ctx.fillRect(cgX - 1, cgY - 1, cgW + 2, cgH + 2);
                    // ê²Œì´ì§€ (íŒŒâ†’ì£¼í™©â†’ë¶‰)
                    const r = Math.round(80 + 175 * chargeRatio2);
                    const g = Math.round(200 - 150 * chargeRatio2);
                    const b = Math.round(255 - 220 * chargeRatio2);
                    ctx.fillStyle = `rgb(${r},${g},${b})`;
                    ctx.shadowColor = `rgb(${r},${g},${b})`;
                    ctx.shadowBlur = 6;
                    ctx.fillRect(cgX, cgY, cgW * Math.max(0, Math.min(1, chargeRatio2)), cgH);
                    ctx.shadowBlur = 0;
                }

                
                // í”Œë ˆì´ì–´ ì›
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(screenX + PLAYER_SIZE / 2, screenY + PLAYER_SIZE / 2, PLAYER_SIZE / 2, 0, Math.PI * 2);
                ctx.fill();
                
                // í…Œë‘ë¦¬
                ctx.strokeStyle = isMe ? '#FFD700' : '#fff';
                ctx.lineWidth = isMe ? 4 : 2;
                ctx.stroke();
                
                // ë‹‰ë„¤ì„ (ì²´ë ¥ë°”ë³´ë‹¤ ë” ìœ„)
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Malgun Gothic';
                ctx.textAlign = 'center';
                ctx.fillText(player.nickname, screenX + PLAYER_SIZE / 2, screenY - 34);

                // ëŒ€ì¥ì¥ì´ ê°•í™” ë ˆë²¨ í‘œì‹œ (ë‹‰ë„¤ì„ ìœ„)
                if (player.class === 'blacksmith' && player.smithEnhanceLevel > 0) {
                    ctx.save();
                    ctx.fillStyle = '#ffd700';
                    ctx.font = `bold 12px Malgun Gothic`;
                    ctx.textAlign = 'center';
                    ctx.shadowColor = '#ff8c00';
                    ctx.shadowBlur = 8;
                    ctx.fillText(`âš’ +${player.smithEnhanceLevel}ê°•`, screenX + PLAYER_SIZE / 2, screenY - 50);
                    ctx.restore();
                }

                // ì‚¬ë¬´ë¼ì´ íŒ¨ë§ ì˜¤ë¼
                if (player.samuraiParrying) {
                    ctx.save();
                    const pulse = 0.4 + 0.3 * Math.sin(Date.now() / 60);
                    ctx.globalAlpha = pulse;
                    ctx.strokeStyle = '#00cfff';
                    ctx.lineWidth = 5;
                    ctx.shadowColor = '#00cfff';
                    ctx.shadowBlur = 22;
                    ctx.beginPath();
                    ctx.arc(screenX + PLAYER_SIZE / 2, screenY + PLAYER_SIZE / 2, PLAYER_SIZE / 2 + 9, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                    // íŒ¨ë§ í…ìŠ¤íŠ¸ (ëŒ€ì¥ì¥ì´ ê°•í™”ì™€ ê°™ì€ ìœ„ì¹˜)
                    ctx.save();
                    ctx.fillStyle = '#00cfff';
                    ctx.font = 'bold 13px Malgun Gothic';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = '#00cfff';
                    ctx.shadowBlur = 8;
                    ctx.fillText('âš” íŒ¨ë§', screenX + PLAYER_SIZE / 2, screenY + PLAYER_SIZE + 35);
                    ctx.restore();
                }
                
                // ì›Œë¦¬ì–´ ìŠ¤í‚¬ ì˜¤ë¼ (Firebase warriorSkillActive ê¸°ë°˜ â†’ ëª¨ë“  í”Œë ˆì´ì–´ì— ë³´ì„)
                if (player.warriorSkillActive) {
                    ctx.save();
                    ctx.globalAlpha = 0.3 + 0.1 * Math.sin(Date.now() / 120);
                    ctx.strokeStyle = '#ff4444';
                    ctx.lineWidth = 4;
                    ctx.shadowColor = '#ff0000';
                    ctx.shadowBlur = 16;
                    ctx.beginPath();
                    ctx.arc(screenX + PLAYER_SIZE / 2, screenY + PLAYER_SIZE / 2, PLAYER_SIZE / 2 + 6, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                }

                // ëŒ€ì¥ì¥ì´ ê°•í™” ê²½ì§ ì˜¤ë¼
                if (player.smithForging) {
                    ctx.save();
                    ctx.globalAlpha = 0.5 + 0.2 * Math.sin(Date.now() / 80);
                    ctx.strokeStyle = '#ffd700';
                    ctx.lineWidth = 5;
                    ctx.shadowColor = '#ff8c00';
                    ctx.shadowBlur = 20;
                    ctx.beginPath();
                    ctx.arc(screenX + PLAYER_SIZE / 2, screenY + PLAYER_SIZE / 2, PLAYER_SIZE / 2 + 8, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                    // ê²½ì§ í…ìŠ¤íŠ¸
                    ctx.save();
                    ctx.fillStyle = '#ffd700';
                    ctx.font = 'bold 13px Malgun Gothic';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = '#ff8c00';
                    ctx.shadowBlur = 8;
                    ctx.fillText('âš’ ê°•í™” ì¤‘...', screenX + PLAYER_SIZE / 2, screenY + PLAYER_SIZE + 35);
                    ctx.restore();
                }

                // ë³¸ì¸ í‘œì‹œ
                if (isMe) {
                    ctx.fillStyle = '#FFD700';
                    ctx.font = 'bold 12px Malgun Gothic';
                    ctx.textAlign = 'center';
                    ctx.fillText('YOU', screenX + PLAYER_SIZE / 2, screenY + PLAYER_SIZE + 20);
                }

                // ì–´ìŒ”ì‹  ì€ì‹  ë³µì›
                ctx.restore();
            }

            // â”€â”€ ì–´ìŒ”ì‹  ì°Œë¥´ê¸° (ëª¨ë“  í”Œë ˆì´ì–´ playerStabs ê¸°ë°˜) â”€â”€
            for (const id in playerStabs) {
                const stab = playerStabs[id];
                const owner = players[id];
                // ì€ì‹  ì¤‘ì¸ ìƒëŒ€ë°© ì°Œë¥´ê¸°ëŠ” ìˆ¨ê¹€ (ë‹¨, ìì‹ ê³¼ ê´€ì „ìëŠ” í‘œì‹œ)
                if (owner && !owner.isMe && owner.stealthed && id !== myPlayerId) continue;
                const progress = 1 - stab.frames / stab.totalFrames;
                const stabLen = ASSASSIN_STAB_RANGE * Math.min(1, progress * 2);
                // ë‚´ ì°Œë¥´ê¸°ëŠ” ì‹¤ì‹œê°„ ìœ„ì¹˜ ì‚¬ìš©, ë‹¤ë¥¸ í”Œë ˆì´ì–´ëŠ” Firebase ì „ì†¡ ìœ„ì¹˜ ì‚¬ìš©
                let scx, scy;
                if (id === myPlayerId && players[myPlayerId]) {
                    scx = players[myPlayerId].x + PLAYER_SIZE / 2 - cameraX;
                    scy = players[myPlayerId].y + PLAYER_SIZE / 2 - cameraY;
                } else {
                    scx = stab.x - cameraX;
                    scy = stab.y - cameraY;
                }
                ctx.save();
                ctx.strokeStyle = '#cc99ff';
                ctx.lineWidth = 3;
                ctx.shadowColor = '#9b59b6';
                ctx.shadowBlur = 12;
                ctx.beginPath();
                ctx.moveTo(scx, scy);
                ctx.lineTo(scx + Math.cos(stab.dir) * stabLen, scy + Math.sin(stab.dir) * stabLen);
                ctx.stroke();
                // ë‹¨ê²€ ë ì 
                ctx.fillStyle = '#ffffff';
                ctx.shadowColor = '#cc99ff';
                ctx.shadowBlur = 8;
                ctx.beginPath();
                ctx.arc(scx + Math.cos(stab.dir) * stabLen, scy + Math.sin(stab.dir) * stabLen, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            // â”€â”€ ì–´ìŒ”ì‹  ì—°ê¸° íŒŒí‹°í´ â”€â”€
            for (const p of assassinSmokeParticles) {
                const sx = p.x - cameraX;
                const sy = p.y - cameraY;
                if (sx < -80 || sx > canvas.width + 80 || sy < -80 || sy > canvas.height + 80) continue;
                ctx.save();
                ctx.globalAlpha = Math.max(0, p.life * 0.55);
                ctx.fillStyle = '#aaaacc';
                ctx.beginPath();
                ctx.arc(sx, sy, Math.max(0.1, p.radius * p.life), 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            // â”€â”€ ì›Œë¦¬ì–´ ê²€ íœ˜ë‘ë¥´ê¸° (ëª¨ë“  í”Œë ˆì´ì–´ playerSwings ê¸°ë°˜) â”€â”€
            for (const id in playerSwings) {
                const sw = playerSwings[id];
                const owner = players[id];
                if (!owner || owner.isSpectator || owner.health <= 0) continue;
                const sx = owner.x - cameraX + PLAYER_SIZE / 2;
                const sy = owner.y - cameraY + PLAYER_SIZE / 2;
                const isSpinAtk = (sw.arc >= Math.PI * 1.9);
                const halfArc = sw.arc / 2;
                const progress = 1 - sw.frames / sw.totalFrames;

                ctx.save();
                ctx.globalAlpha = 0.88;
                ctx.strokeStyle = isSpinAtk ? '#ff6666' : '#e0e0ff';
                ctx.lineWidth = isSpinAtk ? 4 : 3;
                ctx.shadowColor = isSpinAtk ? '#ff2222' : '#aaaaff';
                ctx.shadowBlur = 14;

                // ê²€ í˜¸ (ì§€ë‚˜ì˜¨ ê¶¤ì )
                ctx.beginPath();
                ctx.arc(sx, sy, sw.range, sw.dir - halfArc, sw.dir - halfArc + sw.arc * progress);
                ctx.stroke();

                // ê²€ë‚  (í˜„ì¬ ìœ„ì¹˜)
                ctx.lineWidth = isSpinAtk ? 5 : 3;
                ctx.beginPath();
                ctx.moveTo(sx, sy);
                ctx.lineTo(sx + Math.cos(sw.angle) * sw.range, sy + Math.sin(sw.angle) * sw.range);
                ctx.stroke();
                ctx.restore();
            }
            
            // â”€â”€ ëŒ€ì¥ì¥ì´ ë§ì¹˜ ê³µê²© (ëª¨ë“  í”Œë ˆì´ì–´ playerHammers ê¸°ë°˜) â”€â”€
            for (const id in playerHammers) {
                const h = playerHammers[id];
                const owner = players[id];
                if (!owner || owner.isSpectator || owner.health <= 0) continue;
                // ë‚´ í”Œë ˆì´ì–´ë“  ìƒëŒ€ë°©ì´ë“  í•­ìƒ ì‹¤ì‹œê°„ owner ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ë Œë”ë§
                const cx = owner.x + PLAYER_SIZE / 2 - cameraX;
                const cy = owner.y + PLAYER_SIZE / 2 - cameraY;

                const elapsed = h.totalFrames - h.frames;
                const progress = elapsed / h.totalFrames;
                const alpha = Math.max(0, 1 - progress * 1.2);
                const sqSize = SMITH_HAMMER_RANGE * 2;
                const offsetFront = PLAYER_SIZE / 2 + 4;

                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(h.dir);
                ctx.globalAlpha = alpha;

                ctx.fillStyle = 'rgba(230, 126, 34, 0.55)';
                ctx.shadowColor = '#ff8c00';
                ctx.shadowBlur = 20;
                ctx.fillRect(offsetFront, -sqSize / 2, sqSize, sqSize);

                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 3;
                ctx.shadowColor = '#ffd700';
                ctx.shadowBlur = 14;
                ctx.strokeRect(offsetFront, -sqSize / 2, sqSize, sqSize);

                ctx.restore();
            }

            // â”€â”€ ì‚¬ë¬´ë¼ì´ ì°Œë¥´ê¸° / ë°˜ê²© ì´í™íŠ¸ â”€â”€
            for (const key in playerSamuraiSlashes) {
                const s = playerSamuraiSlashes[key];
                const owner = players[s.ownerId];
                if (!owner || owner.isSpectator || owner.health <= 0) continue;
                const sx = owner.x + PLAYER_SIZE / 2 - cameraX;
                const sy = owner.y + PLAYER_SIZE / 2 - cameraY;
                const progress = s.progress !== undefined ? s.progress : (1 - s.frames / (s.totalFrames || SAMURAI_SLASH_TOTAL));

                ctx.save();

                if (s.type === 'counter') {
                    // ë°˜ê²© ëŒì§„ â€” ê°•ë ¬í•œ ë¶‰ì€ ì”ìƒ
                    ctx.globalAlpha = Math.max(0, 0.75 - progress * 0.8);
                    ctx.strokeStyle = '#ff2244';
                    ctx.lineWidth = 6;
                    ctx.shadowColor = '#ff0033';
                    ctx.shadowBlur = 22;
                    ctx.beginPath();
                    ctx.moveTo(sx, sy);
                    ctx.lineTo(sx + Math.cos(s.dir + Math.PI) * 55, sy + Math.sin(s.dir + Math.PI) * 55);
                    ctx.stroke();
                    // ì•ìª½ ì¶©ê²© ì›
                    ctx.globalAlpha = Math.max(0, 0.6 - progress * 0.7);
                    ctx.strokeStyle = '#ffaaaa';
                    ctx.lineWidth = 3;
                    ctx.shadowBlur = 14;
                    ctx.beginPath();
                    ctx.arc(sx + Math.cos(s.dir) * 18, sy + Math.sin(s.dir) * 18, 18, 0, Math.PI * 2);
                    ctx.stroke();
                } else {
                    // ì°Œë¥´ê¸° â€” ì‚¬ê°í˜• ê¶¤ì  (ì°¨ì§• ë ˆë²¨ë³„ í¬ê¸°)
                    const tLen = (s.thrustLength || 155) * progress;
                    const tW   = s.thrustWidth  || 28;
                    ctx.globalAlpha = 0.45;
                    ctx.fillStyle = '#aaddff';
                    ctx.shadowColor = '#6699ff';
                    ctx.shadowBlur = 12;
                    ctx.save();
                    ctx.translate(sx, sy);
                    ctx.rotate(s.dir);
                    ctx.fillRect(-PLAYER_SIZE, -tW / 2, tLen + PLAYER_SIZE, tW);
                    ctx.restore();
                }
                ctx.restore();
            }

            // íŒŒí‹°í´ (ëŒ€ì‰¬ ë¨¼ì§€/ì”ìƒ) ê·¸ë¦¬ê¸°
            for (const p of particles) {
                const sx = p.x - cameraX;
                const sy = p.y - cameraY;
                // í™”ë©´ ë°– ìŠ¤í‚µ
                if (sx < -50 || sx > canvas.width + 50 || sy < -50 || sy > canvas.height + 50) continue;
                ctx.save();
                ctx.globalAlpha = Math.max(0, p.life * 0.75);
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(sx, sy, Math.max(0.1, p.radius * p.life), 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            // íˆíŠ¸ ì´í™íŠ¸ ê·¸ë¦¬ê¸°
            for (const e of hitEffects) {
                const sx = e.x - cameraX;
                const sy = e.y - cameraY;
                // í™”ë©´ ë°– ìŠ¤í‚µ
                if (sx < -50 || sx > canvas.width + 50 || sy < -50 || sy > canvas.height + 50) continue;
                ctx.save();
                ctx.globalAlpha = Math.max(0, e.life * 0.9);
                ctx.fillStyle = e.color;
                ctx.shadowColor = e.color;
                ctx.shadowBlur = 6;
                ctx.beginPath();
                ctx.arc(sx, sy, Math.max(0.1, e.radius * e.life), 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            // í™”ë©´ í”Œë˜ì‹œ (í”¼ê²© ì‹œ)
            if (screenFlashColor && Date.now() < screenFlashEnd) {
                const prog = (screenFlashEnd - Date.now()) / (screenFlashEnd - Date.now() + 50);
                ctx.fillStyle = screenFlashColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                screenFlashColor = null;
            }

            // ì´ì•Œ ê·¸ë¦¬ê¸°
            for (let bullet of bullets) {
                const screenX = bullet.x - cameraX;
                const screenY = bullet.y - cameraY;
                
                if (screenX < -20 || screenX > canvas.width + 20 || 
                    screenY < -20 || screenY > canvas.height + 20) {
                    continue;
                }
                
                ctx.fillStyle = bullet.isSkillBullet ? '#ff0000' : '#ffff00';
                ctx.beginPath();
                ctx.arc(screenX, screenY, bullet.isSkillBullet ? 6 : 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = bullet.isSkillBullet ? '#ff6666' : '#ffff99';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            // ë§ˆìš°ìŠ¤ ì»¤ì„œ ìœ„ì¹˜ì— ì¡°ì¤€ì„  ê·¸ë¦¬ê¸°
            if (myPlayerId && players[myPlayerId] && !isSpectating && isAlive) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(mouseX - 10, mouseY);
                ctx.lineTo(mouseX + 10, mouseY);
                ctx.moveTo(mouseX, mouseY - 10);
                ctx.lineTo(mouseX, mouseY + 10);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 8, 0, Math.PI * 2);
                ctx.stroke();
            }

            // ê´€ì „ UI
            if (isSpectating || !isAlive) {
                // ë°˜íˆ¬ëª… ìƒë‹¨ ë°°ë„ˆ
                ctx.fillStyle = 'rgba(0, 0, 0, 0.55)';
                ctx.fillRect(0, 0, canvas.width, 50);

                ctx.fillStyle = '#00fff5';
                ctx.font = 'bold 18px Malgun Gothic';
                ctx.textAlign = 'center';

                if (spectateTargetId && players[spectateTargetId]) {
                    const targetName = players[spectateTargetId].nickname;
                    ctx.fillText(`ğŸ‘ ê´€ì „ ì¤‘: ${targetName}`, canvas.width / 2, 32);
                } else {
                    ctx.fillStyle = '#aaa';
                    ctx.fillText('ğŸ‘ ê´€ì „ ì¤‘ â€” ì‚´ì•„ìˆëŠ” í”Œë ˆì´ì–´ ì—†ìŒ', canvas.width / 2, 32);
                }
            }

            // Rí‚¤ ê°•ì œ ì¢…ë£Œ ì§„í–‰ ë°”
            if (rKeyHolding && forceStopProgress > 0) {
                const barWidth = 300;
                const barHeight = 24;
                const barX = canvas.width / 2 - barWidth / 2;
                const barY = canvas.height - 60;

                // ë°°ê²½
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(barX - 5, barY - 5, barWidth + 10, barHeight + 10);

                // ì§„í–‰ ë°”
                ctx.fillStyle = '#ff4444';
                ctx.fillRect(barX, barY, barWidth * (forceStopProgress / 100), barHeight);

                // í…Œë‘ë¦¬
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 2;
                ctx.strokeRect(barX, barY, barWidth, barHeight);

                // í…ìŠ¤íŠ¸
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Malgun Gothic';
                ctx.textAlign = 'center';
                ctx.fillText(`âš  ê²Œì„ ê°•ì œ ì¢…ë£Œ ì¤‘... ${Math.ceil(3 - (forceStopProgress / 100) * 3)}ì´ˆ`, canvas.width / 2, barY + 17);
            }
        }

        function updatePlayerList() {
            const playerCount = Object.keys(players).length;
            document.getElementById('playerCount').textContent = playerCount;
            
            const listContent = document.getElementById('playerListContent');
            listContent.innerHTML = '';
            
            for (let id in players) {
                const player = players[id];
                const isMe = id === myPlayerId;
                
                const item = document.createElement('div');
                item.className = 'player-item';
                item.innerHTML = `
                    <div class="player-color" style="background: ${player.color}"></div>
                    <div>
                        <div><strong>${player.nickname}</strong> ${isMe ? '(ë‚˜)' : ''}</div>
                        <div style="font-size: 12px; color: #aaa;">${player.className}</div>
                    </div>
                `;
                listContent.appendChild(item);
            }
        }
    </script>
</body>
</html>
